<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin â€“ architekturbÃ¼ro schels</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
  <style>
:root{--bg:#fff;--sidebar:#fafafa;--text:#000;--border:#e0e0e0;--accent:#000;--hover:#f0f0f0;--success:#2e7d32;--error:#c62828}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;height:100vh;overflow:hidden}
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--sidebar)}
.login-box{background:var(--bg);padding:3rem;max-width:360px;width:100%;border:1px solid var(--border)}
.login-box h1{font-weight:200;font-size:1.3rem;letter-spacing:.2em;margin-bottom:.5rem}
.login-box h1 span{display:block;font-size:1.5rem}
.login-box .subtitle{font-size:.85rem;color:#666;margin-bottom:2rem}
input[type="password"],input[type="text"],input[type="number"],select,textarea{width:100%;padding:.6rem .8rem;border:1px solid var(--border);font-size:.9rem;font-family:inherit;margin-bottom:.6rem;background:var(--bg);color:var(--text);border-radius:0}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
textarea{min-height:80px;resize:vertical}
button{padding:.6rem 1.2rem;background:var(--accent);color:var(--bg);border:none;cursor:pointer;font-size:.85rem;letter-spacing:.02em;transition:opacity .2s;border-radius:0}
button:hover{opacity:.8}
button:disabled{opacity:.4;cursor:not-allowed}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-small{padding:.35rem .7rem;font-size:.75rem}
.btn-success{background:var(--success)}
.error{color:var(--error);font-size:.8rem;margin-top:.3rem}
.success{color:var(--success);font-size:.8rem}
.admin-layout{display:none;height:100vh}
.admin-layout.active{display:flex}
.sidebar{width:180px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-header{padding:1rem;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-weight:200;font-size:.85rem;letter-spacing:.1em}
.sidebar-header h1 span{font-weight:400}
.sidebar-nav{flex:1;overflow-y:auto;padding:.3rem 0}
.nav-section{padding:.4rem .8rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.08em;color:#999;margin-top:.6rem}
.nav-item{display:block;padding:.45rem 1rem;color:var(--text);text-decoration:none;font-size:.8rem;border-left:3px solid transparent;transition:all .12s}
.nav-item:hover{background:var(--hover)}
.nav-item.active{background:var(--hover);border-left-color:var(--accent);font-weight:500}
.sidebar-footer{padding:.6rem;border-top:1px solid var(--border);font-size:.7rem}
.sidebar-footer button{width:100%;margin-bottom:.3rem;font-size:.75rem;padding:.5rem}
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:.6rem 1rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--bg)}
.main-header h2{font-weight:400;font-size:.95rem;letter-spacing:.04em}
.header-actions{display:flex;gap:.4rem;align-items:center}
.view-toggle{display:flex;border:1px solid var(--border);overflow:hidden}
.view-toggle button{border:none;background:var(--bg);padding:.3rem .6rem;font-size:.7rem;border-right:1px solid var(--border)}
.view-toggle button:last-child{border-right:none}
.view-toggle button.active{background:var(--accent);color:var(--bg)}
.view-toggle button:hover:not(.active){background:var(--hover)}
.main-body{flex:1;display:flex;overflow:hidden}
.panel{display:none;flex:1;flex-direction:column;overflow:hidden}
.panel.active{display:flex}
.editor-container{flex:1;display:flex;overflow:hidden}
.code-pane{flex:1;display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border)}
.code-pane.hidden{display:none}
.preview-pane{flex:1;overflow:auto;background:#fff}
.preview-pane.hidden{display:none}
.preview-pane.full{border-right:none}
.CodeMirror{height:100%;font-size:13px;font-family:'SF Mono',Monaco,Consolas,monospace}
.preview-frame{width:100%;height:100%;border:none}
.preview-content{padding:1.5rem;font-family:-apple-system,BlinkMacSystemFont,'Avenir Next','Segoe UI',sans-serif;font-weight:200;line-height:1.6}
.preview-content h2,.preview-content h3{font-weight:200;letter-spacing:.15em;text-transform:uppercase;margin:1.5rem 0 .75rem}
.preview-content h2{font-size:1.4em}
.preview-content h3{font-size:1.2em}
.preview-content h2:first-child,.preview-content h3:first-child{margin-top:0}
.preview-content p{margin:0 0 1rem}
.preview-content strong{font-weight:400;text-transform:uppercase;letter-spacing:.08em}
.preview-content em,.preview-content i{font-style:italic}
.preview-content ul,.preview-content ol{margin:0 0 1rem;padding-left:1.5rem}
.preview-content li{margin-bottom:.5rem}
.preview-content table{width:100%;border-collapse:collapse;margin:1rem 0}
.preview-content td,.preview-content th{padding:.5rem;vertical-align:top;border-bottom:1px solid #e0e0e0;text-align:left}
.preview-content blockquote{margin:1rem 0;padding-left:1rem;border-left:2px solid #000;font-style:italic}
.preview-content a{color:#000;text-decoration:underline;text-decoration-style:dotted}
.preview-content small{font-size:.85em;color:#666}
.preview-content .brand-name{font-weight:400}
.seo-panel{padding:1.5rem;overflow-y:auto}
.editor-group{margin-bottom:1.5rem}
.editor-group>label{display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.06em;color:#666;margin-bottom:.4rem}
.editor-group .hint{font-size:.75rem;color:#999;margin-top:.2rem}
.section-title{font-size:.9rem;font-weight:500;margin:1.5rem 0 1rem;padding-bottom:.4rem;border-bottom:1px solid var(--border)}
.section-title:first-child{margin-top:0}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.char-count{font-size:.7rem;color:#999;margin-top:.2rem}
.char-count.warning{color:#f57c00}
.char-count.error{color:var(--error)}
.status-bar{position:fixed;bottom:0;left:180px;right:0;padding:.5rem 1rem;background:var(--accent);color:var(--bg);display:none;font-size:.8rem}
.status-bar.error{background:var(--error)}
.status-bar.success{background:var(--success)}
.status-bar.active{display:block}
.unsaved-indicator{display:none;width:8px;height:8px;background:orange;border-radius:50%;margin-left:.5rem}
.unsaved-indicator.active{display:inline-block}
.info-box{background:#e3f2fd;border:1px solid #90caf9;padding:1rem;margin-bottom:1rem;font-size:.85rem;border-radius:2px}
@media(max-width:768px){.sidebar{width:140px}.code-pane{min-width:200px}}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <h1>architekturbÃ¼ro<span>schels</span></h1>
      <p class="subtitle">Admin Panel</p>
      <form id="login-form">
        <input type="password" id="password" placeholder="Passwort" required>
        <button type="submit" style="width:100%">Anmelden</button>
        <div id="login-error" class="error"></div>
      </form>
      <div id="setup-box" style="display:none">
        <p style="margin-bottom:.8rem;font-size:.85rem">Erstes Login â€“ Passwort festlegen:</p>
        <input type="password" id="new-password" placeholder="Neues Passwort">
        <input type="password" id="confirm-password" placeholder="Passwort bestÃ¤tigen">
        <button type="button" id="set-pw-btn" style="width:100%">Passwort setzen</button>
        <div id="setup-error" class="error"></div>
      </div>
    </div>
  </div>

  <!-- Admin Layout -->
  <div id="admin-layout" class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>architekturbÃ¼ro <span>schels</span></h1>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">Hauptseite</div>
        <a href="#" class="nav-item active" data-panel="profil" data-section="content1">Profil</a>
        <a href="#" class="nav-item" data-panel="vita" data-section="content2">Vita</a>
        <a href="#" class="nav-item" data-panel="leistungen" data-section="content3">Leistungen</a>
        <a href="#" class="nav-item" data-panel="referenzen" data-section="content4">Referenzen</a>
        <a href="#" class="nav-item" data-panel="kontakt" data-section="content5">Kontakt</a>
        <div class="nav-section">Unterseiten</div>
        <a href="#" class="nav-item" data-panel="impressum" data-file="pages/impressum.html">Impressum</a>
        <a href="#" class="nav-item" data-panel="datenschutz" data-file="pages/datenschutz.html">Datenschutz</a>
        <div class="nav-section">Einstellungen</div>
        <a href="#" class="nav-item" data-panel="seo">SEO & Meta</a>
        <a href="#" class="nav-item" data-panel="settings">GitHub & Passwort</a>
      </nav>
      <div class="sidebar-footer">
        <button id="save-btn" class="btn-success">ðŸ’¾ Speichern</button>
        <button id="logout-btn" class="btn-secondary">Abmelden</button>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h2 id="panel-title">Profil <span class="unsaved-indicator" id="unsaved"></span></h2>
        <div class="header-actions">
          <div class="view-toggle">
            <button data-view="split" class="active">Split</button>
            <button data-view="code">Code</button>
            <button data-view="preview">Vorschau</button>
          </div>
          <button id="preview-btn" class="btn-secondary btn-small" onclick="window.open('/','_blank')">Live â†—</button>
        </div>
      </header>

      <div class="main-body">
        <!-- Editor Panels (for sections) -->
        <div id="profil-panel" class="panel active">
          <div class="editor-container">
            <div class="code-pane"><textarea id="editor-profil"></textarea></div>
            <div class="preview-pane"><div class="preview-content" id="preview-profil"></div></div>
          </div>
        </div>

        <div id="vita-panel" class="panel">
          <div class="editor-container">
            <div class="code-pane"><textarea id="editor-vita"></textarea></div>
            <div class="preview-pane"><div class="preview-content" id="preview-vita"></div></div>
          </div>
        </div>

        <div id="leistungen-panel" class="panel">
          <div class="editor-container">
            <div class="code-pane"><textarea id="editor-leistungen"></textarea></div>
            <div class="preview-pane"><div class="preview-content" id="preview-leistungen"></div></div>
          </div>
        </div>

        <div id="referenzen-panel" class="panel">
          <div class="editor-container">
            <div class="code-pane"><textarea id="editor-referenzen"></textarea></div>
            <div class="preview-pane"><div class="preview-content" id="preview-referenzen"></div></div>
          </div>
        </div>

        <div id="kontakt-panel" class="panel">
          <div class="editor-container">
            <div class="code-pane"><textarea id="editor-kontakt"></textarea></div>
            <div class="preview-pane"><div class="preview-content" id="preview-kontakt"></div></div>
          </div>
        </div>

        <div id="impressum-panel" class="panel">
          <div class="editor-container">
            <div class="code-pane"><textarea id="editor-impressum"></textarea></div>
            <div class="preview-pane"><div class="preview-content" id="preview-impressum"></div></div>
          </div>
        </div>

        <div id="datenschutz-panel" class="panel">
          <div class="editor-container">
            <div class="code-pane"><textarea id="editor-datenschutz"></textarea></div>
            <div class="preview-pane"><div class="preview-content" id="preview-datenschutz"></div></div>
          </div>
        </div>

        <!-- SEO Panel -->
        <div id="seo-panel" class="panel">
          <div class="seo-panel">
            <div class="info-box">
              <strong>SEO Meta-Tags</strong> â€“ Diese Felder beeinflussen, wie deine Website in Google erscheint.
            </div>
            <div class="section-title">Suchmaschinen</div>
            <div class="editor-group">
              <label>Seitentitel (Title)</label>
              <input type="text" id="seo-title" oninput="updateCharCount(this,60)">
              <div class="char-count" id="seo-title-count">0/60</div>
            </div>
            <div class="editor-group">
              <label>Beschreibung (Description)</label>
              <textarea id="seo-description" rows="3" oninput="updateCharCount(this,160)"></textarea>
              <div class="char-count" id="seo-description-count">0/160</div>
            </div>
            <div class="editor-group">
              <label>Keywords</label>
              <textarea id="seo-keywords" rows="2"></textarea>
              <p class="hint">Kommagetrennt</p>
            </div>
            <div class="section-title">Social Media (Open Graph)</div>
            <div class="editor-group">
              <label>OG Title</label>
              <input type="text" id="seo-og-title">
            </div>
            <div class="editor-group">
              <label>OG Description</label>
              <textarea id="seo-og-description" rows="2"></textarea>
            </div>
          </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="panel">
          <div class="seo-panel">
            <div class="section-title">GitHub Verbindung</div>
            <div class="editor-group">
              <label>Personal Access Token</label>
              <input type="password" id="github-token" placeholder="ghp_...">
              <p class="hint"><a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank">Token erstellen â†’</a></p>
            </div>
            <div class="two-col">
              <div class="editor-group"><label>Repository</label><input type="text" id="github-repo" value="bschels/bschels.github.io"></div>
              <div class="editor-group"><label>Branch</label><input type="text" id="github-branch" value="main"></div>
            </div>
            <button id="test-github" class="btn-secondary">Verbindung testen</button>
            <span id="github-status" style="margin-left:.5rem;font-size:.8rem"></span>

            <div class="section-title" style="margin-top:2rem">Passwort Ã¤ndern</div>
            <div class="two-col">
              <div class="editor-group"><label>Aktuelles Passwort</label><input type="password" id="pw-current"></div>
              <div class="editor-group"><label>Neues Passwort</label><input type="password" id="pw-new"></div>
            </div>
            <button id="change-pw" class="btn-secondary">Passwort Ã¤ndern</button>
            <span id="pw-status" style="margin-left:.5rem;font-size:.8rem"></span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="status-bar" class="status-bar"></div>

  <!-- CodeMirror -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/xml-fold.min.js"></script>
  <script>
(function(){
  'use strict';
  const $=id=>document.getElementById(id);
  const $$=sel=>document.querySelectorAll(sel);
  const hash=s=>s.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0).toString(16);

  // State
  let editors = {};
  let hasChanges = false;
  let currentPanel = 'profil';
  let currentView = 'split';
  let indexHtml = '';
  let indexDoc = null;

  // Section mappings
  const sections = {
    profil: { id: 'content1', preserve: ['.cv-header', 'blockquote', '.cta-link'] },
    vita: { id: 'content2', preserve: [] },
    leistungen: { id: 'content3', preserve: [] },
    referenzen: { id: 'content4', preserve: [] },
    kontakt: { id: 'content5', preserve: ['.contact-form-section'] }
  };

  // Initialize
  function init() {
    if (!localStorage.getItem('admin_pw')) {
      $('login-form').style.display = 'none';
      $('setup-box').style.display = 'block';
    }
    if (sessionStorage.getItem('admin_auth')) showAdmin();
    bindEvents();
  }

  function bindEvents() {
    // Password setup
    $('set-pw-btn').onclick = () => {
      const pw = $('new-password').value, c = $('confirm-password').value;
      if (pw.length < 4) return $('setup-error').textContent = 'Mind. 4 Zeichen';
      if (pw !== c) return $('setup-error').textContent = 'PasswÃ¶rter stimmen nicht Ã¼berein';
      localStorage.setItem('admin_pw', hash(pw));
      location.reload();
    };

    // Login
    $('login-form').onsubmit = e => {
      e.preventDefault();
      if (hash($('password').value) === localStorage.getItem('admin_pw')) {
        sessionStorage.setItem('admin_auth', '1');
        showAdmin();
      } else {
        $('login-error').textContent = 'Falsches Passwort';
      }
    };

    // Logout
    $('logout-btn').onclick = () => {
      sessionStorage.removeItem('admin_auth');
      location.reload();
    };

    // Navigation
    $$('.nav-item').forEach(n => n.onclick = e => {
      e.preventDefault();
      $$('.nav-item').forEach(i => i.classList.remove('active'));
      $$('.panel').forEach(p => p.classList.remove('active'));
      n.classList.add('active');
      const panel = n.dataset.panel;
      $(panel + '-panel').classList.add('active');
      $('panel-title').innerHTML = n.textContent + '<span class="unsaved-indicator' + (hasChanges ? ' active' : '') + '" id="unsaved"></span>';
      currentPanel = panel;
      
      // Refresh editor if exists
      if (editors[panel]) {
        setTimeout(() => editors[panel].refresh(), 10);
      }
    });

    // View toggle
    $$('.view-toggle button').forEach(btn => btn.onclick = () => {
      $$('.view-toggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentView = btn.dataset.view;
      updateView();
    });

    // Save
    $('save-btn').onclick = saveAll;

    // Settings
    $('test-github').onclick = testGitHub;
    $('change-pw').onclick = changePw;

    // Track SEO changes
    ['seo-title', 'seo-description', 'seo-keywords', 'seo-og-title', 'seo-og-description'].forEach(id => {
      $(id).addEventListener('input', markChanged);
    });
  }

  function showAdmin() {
    $('login-screen').style.display = 'none';
    $('admin-layout').classList.add('active');
    loadSettings();
    initEditors();
    loadContent();
  }

  function initEditors() {
    const editorIds = ['profil', 'vita', 'leistungen', 'referenzen', 'kontakt', 'impressum', 'datenschutz'];
    
    editorIds.forEach(id => {
      const textarea = $('editor-' + id);
      if (textarea) {
        editors[id] = CodeMirror.fromTextArea(textarea, {
          mode: 'htmlmixed',
          theme: 'dracula',
          lineNumbers: true,
          lineWrapping: true,
          autoCloseTags: true,
          foldGutter: true,
          gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
          indentUnit: 2,
          tabSize: 2
        });
        
        // Live preview update
        editors[id].on('change', () => {
          markChanged();
          updatePreview(id);
        });
      }
    });
  }

  function updatePreview(id) {
    const preview = $('preview-' + id);
    if (preview && editors[id]) {
      preview.innerHTML = editors[id].getValue();
    }
  }

  function updateView() {
    $$('.code-pane').forEach(pane => {
      pane.classList.toggle('hidden', currentView === 'preview');
    });
    $$('.preview-pane').forEach(pane => {
      pane.classList.toggle('hidden', currentView === 'code');
      pane.classList.toggle('full', currentView === 'preview');
    });
    // Refresh current editor
    if (editors[currentPanel]) {
      setTimeout(() => editors[currentPanel].refresh(), 10);
    }
  }

  function loadSettings() {
    $('github-token').value = localStorage.getItem('gh_token') || '';
    $('github-repo').value = localStorage.getItem('gh_repo') || 'bschels/bschels.github.io';
    $('github-branch').value = localStorage.getItem('gh_branch') || 'main';
  }

  async function loadContent() {
    showStatus('Lade Inhalte...');
    try {
      // Load index.html
      const indexRes = await fetch('/index.html?t=' + Date.now());
      if (!indexRes.ok) throw new Error('index.html nicht gefunden');
      indexHtml = await indexRes.text();
      indexDoc = new DOMParser().parseFromString(indexHtml, 'text/html');

      // Extract sections
      Object.keys(sections).forEach(key => {
        const section = sections[key];
        const el = indexDoc.getElementById(section.id);
        if (el && editors[key]) {
          let html = el.innerHTML;
          // Remove preserved elements from editable content
          const temp = document.createElement('div');
          temp.innerHTML = html;
          section.preserve.forEach(sel => {
            temp.querySelectorAll(sel).forEach(e => e.remove());
          });
          // Remove trailing hr.z
          const hrs = temp.querySelectorAll('hr.z');
          hrs.forEach(hr => hr.remove());
          // Clean and set
          html = temp.innerHTML.trim();
          editors[key].setValue(html);
          updatePreview(key);
        }
      });

      // Load impressum
      try {
        const impRes = await fetch('/pages/impressum.html?t=' + Date.now());
        if (impRes.ok && editors.impressum) {
          editors.impressum.setValue(await impRes.text());
          updatePreview('impressum');
        }
      } catch (e) { console.log('Impressum nicht geladen'); }

      // Load datenschutz
      try {
        const dsRes = await fetch('/pages/datenschutz.html?t=' + Date.now());
        if (dsRes.ok && editors.datenschutz) {
          editors.datenschutz.setValue(await dsRes.text());
          updatePreview('datenschutz');
        }
      } catch (e) { console.log('Datenschutz nicht geladen'); }

      // Load SEO
      $('seo-title').value = indexDoc.querySelector('title')?.textContent || '';
      $('seo-description').value = indexDoc.querySelector('meta[name="description"]')?.content || '';
      $('seo-keywords').value = indexDoc.querySelector('meta[name="keywords"]')?.content || '';
      $('seo-og-title').value = indexDoc.querySelector('meta[property="og:title"]')?.content || '';
      $('seo-og-description').value = indexDoc.querySelector('meta[property="og:description"]')?.content || '';
      
      // Update char counts
      updateCharCount($('seo-title'), 60);
      updateCharCount($('seo-description'), 160);

      hasChanges = false;
      showStatus('Inhalte geladen âœ“', 'success');
      setTimeout(hideStatus, 2000);
    } catch (e) {
      console.error(e);
      showStatus('Fehler: ' + e.message, 'error');
    }
  }

  function markChanged() {
    hasChanges = true;
    const indicator = $('unsaved');
    if (indicator) indicator.classList.add('active');
  }

  async function saveAll() {
    const btn = $('save-btn');
    btn.disabled = true;
    btn.textContent = 'Speichert...';
    showStatus('Speichert...');

    const token = localStorage.getItem('gh_token') || $('github-token').value;
    if (!token) {
      showStatus('GitHub Token fehlt!', 'error');
      btn.disabled = false;
      btn.textContent = 'ðŸ’¾ Speichern';
      return;
    }

    // Save settings
    localStorage.setItem('gh_token', $('github-token').value);
    localStorage.setItem('gh_repo', $('github-repo').value);
    localStorage.setItem('gh_branch', $('github-branch').value);

    try {
      // 1. Save index.html with all sections
      await saveIndexHtml();

      // 2. Save impressum
      if (editors.impressum) {
        await saveFile('pages/impressum.html', editors.impressum.getValue());
      }

      // 3. Save datenschutz
      if (editors.datenschutz) {
        await saveFile('pages/datenschutz.html', editors.datenschutz.getValue());
      }

      hasChanges = false;
      const indicator = $('unsaved');
      if (indicator) indicator.classList.remove('active');
      showStatus('Gespeichert & verÃ¶ffentlicht âœ“', 'success');
      setTimeout(hideStatus, 3000);
    } catch (e) {
      console.error('Save error:', e);
      showStatus('Fehler: ' + e.message, 'error');
    }

    btn.disabled = false;
    btn.textContent = 'ðŸ’¾ Speichern';
  }

  async function saveIndexHtml() {
    const token = localStorage.getItem('gh_token');
    const repo = localStorage.getItem('gh_repo');
    const branch = localStorage.getItem('gh_branch') || 'main';

    // Fetch fresh index.html from GitHub
    const ghRes = await fetch(`https://api.github.com/repos/${repo}/contents/index.html?ref=${branch}`, {
      headers: { Authorization: `token ${token}` }
    });
    if (!ghRes.ok) throw new Error('index.html nicht auf GitHub gefunden');
    const ghData = await ghRes.json();
    let html = decodeURIComponent(escape(atob(ghData.content)));

    // Update SEO via string replacement
    const seoUpdates = [
      { regex: /<title>[^<]*<\/title>/, value: `<title>${escapeHtml($('seo-title').value)}</title>` },
      { regex: /<meta name="description" content="[^"]*"/, value: `<meta name="description" content="${escapeAttr($('seo-description').value)}"` },
      { regex: /<meta name="keywords" content="[^"]*"/, value: `<meta name="keywords" content="${escapeAttr($('seo-keywords').value)}"` },
      { regex: /<meta property="og:title" content="[^"]*"/, value: `<meta property="og:title" content="${escapeAttr($('seo-og-title').value)}"` },
      { regex: /<meta property="og:description" content="[^"]*"/, value: `<meta property="og:description" content="${escapeAttr($('seo-og-description').value)}"` }
    ];
    seoUpdates.forEach(u => { html = html.replace(u.regex, u.value); });

    // Update sections via regex (preserve structure)
    Object.keys(sections).forEach(key => {
      if (!editors[key]) return;
      const section = sections[key];
      const sectionId = section.id;
      
      // Find section in HTML
      const regex = new RegExp(
        `(<div[^>]*id="${sectionId}"[^>]*>)([\\s\\S]*?)(<hr class="z">\\s*</div>)`,
        'i'
      );
      
      const match = html.match(regex);
      if (match) {
        // Get preserved content from original
        const tempDoc = new DOMParser().parseFromString(html, 'text/html');
        const originalSection = tempDoc.getElementById(sectionId);
        let preservedContent = '';
        let preservedEnd = '';
        
        if (originalSection) {
          section.preserve.forEach(sel => {
            const preserved = originalSection.querySelector(sel);
            if (preserved) {
              if (sel === '.cv-header') {
                preservedContent = preserved.outerHTML + preservedContent;
              } else if (sel === '.contact-form-section') {
                preservedEnd += preserved.outerHTML;
              } else {
                preservedEnd += preserved.outerHTML;
              }
            }
          });
        }

        // Build new section content
        let newContent = preservedContent + editors[key].getValue() + preservedEnd;
        
        // Replace in HTML
        html = html.replace(regex, `$1${newContent}<hr class="z"></div>`);
      }
    });

    await saveFile('index.html', html, ghData.sha);
  }

  async function saveFile(path, content, sha) {
    const token = localStorage.getItem('gh_token');
    const repo = localStorage.getItem('gh_repo');
    const branch = localStorage.getItem('gh_branch') || 'main';

    // Get SHA if not provided
    if (!sha) {
      try {
        const r = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
          headers: { Authorization: `token ${token}` }
        });
        if (r.ok) sha = (await r.json()).sha;
      } catch (e) {}
    }

    const body = {
      message: `Admin: ${path} aktualisiert`,
      content: btoa(unescape(encodeURIComponent(content))),
      branch
    };
    if (sha) body.sha = sha;

    const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || 'GitHub Fehler');
    }
  }

  function escapeHtml(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
  function escapeAttr(s) { return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

  async function testGitHub() {
    const token = $('github-token').value;
    const repo = $('github-repo').value;
    try {
      const r = await fetch(`https://api.github.com/repos/${repo}`, { headers: { Authorization: `token ${token}` } });
      if (r.ok) {
        $('github-status').innerHTML = '<span class="success">âœ“ Verbunden</span>';
        localStorage.setItem('gh_token', token);
        localStorage.setItem('gh_repo', repo);
        localStorage.setItem('gh_branch', $('github-branch').value);
      } else {
        $('github-status').innerHTML = '<span class="error">Fehler ' + r.status + '</span>';
      }
    } catch (e) {
      $('github-status').innerHTML = '<span class="error">Verbindungsfehler</span>';
    }
  }

  function changePw() {
    const curr = $('pw-current').value, newPw = $('pw-new').value;
    if (hash(curr) !== localStorage.getItem('admin_pw')) {
      return $('pw-status').innerHTML = '<span class="error">Falsches Passwort</span>';
    }
    if (newPw.length < 4) {
      return $('pw-status').innerHTML = '<span class="error">Mind. 4 Zeichen</span>';
    }
    localStorage.setItem('admin_pw', hash(newPw));
    $('pw-status').innerHTML = '<span class="success">âœ“ GeÃ¤ndert</span>';
    $('pw-current').value = '';
    $('pw-new').value = '';
  }

  function showStatus(msg, type = '') {
    const el = $('status-bar');
    el.textContent = msg;
    el.className = 'status-bar active' + (type ? ' ' + type : '');
  }

  function hideStatus() {
    $('status-bar').classList.remove('active');
  }

  // Global for char count
  window.updateCharCount = function(el, max) {
    const len = el.value.length;
    const countEl = $(el.id + '-count');
    if (countEl) {
      countEl.textContent = len + '/' + max;
      countEl.className = 'char-count';
      if (len > max) countEl.classList.add('error');
      else if (len > max * 0.9) countEl.classList.add('warning');
    }
  };

  init();
})();
  </script>
</body>
</html>
