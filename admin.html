<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin ‚Äì architekturb√ºro schels</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
  <style>
:root{--bg:#fff;--sidebar:#fafafa;--text:#000;--border:#e0e0e0;--accent:#000;--hover:#f0f0f0;--success:#2e7d32;--error:#c62828}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;height:100vh;overflow:hidden}
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--sidebar)}
.login-box{background:var(--bg);padding:2.5rem;max-width:340px;width:100%;border:1px solid var(--border)}
.login-box h1{font-weight:200;font-size:1.2rem;letter-spacing:.15em;margin-bottom:.4rem}
.login-box h1 span{display:block;font-size:1.4rem}
.login-box .subtitle{font-size:.8rem;color:#666;margin-bottom:1.5rem}
input[type="password"],input[type="text"],select,textarea{width:100%;padding:.5rem .7rem;border:1px solid var(--border);font-size:.85rem;font-family:inherit;margin-bottom:.5rem;background:var(--bg);color:var(--text);border-radius:0}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
textarea{min-height:70px;resize:vertical}
button{padding:.5rem 1rem;background:var(--accent);color:var(--bg);border:none;cursor:pointer;font-size:.8rem;letter-spacing:.02em;transition:opacity .15s;border-radius:0}
button:hover{opacity:.8}
button:disabled{opacity:.4;cursor:not-allowed}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-small{padding:.3rem .6rem;font-size:.7rem}
.btn-success{background:var(--success)}
.error{color:var(--error);font-size:.75rem;margin-top:.2rem}
.success{color:var(--success);font-size:.75rem}
.admin-layout{display:none;height:100vh}
.admin-layout.active{display:flex}
.sidebar{width:170px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-header{padding:.8rem;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-weight:200;font-size:.75rem;letter-spacing:.08em}
.sidebar-header h1 span{font-weight:400}
.sidebar-nav{flex:1;overflow-y:auto;padding:.2rem 0}
.nav-section{padding:.3rem .7rem;font-size:.55rem;text-transform:uppercase;letter-spacing:.06em;color:#999;margin-top:.5rem}
.nav-item{display:block;padding:.4rem .8rem;color:var(--text);text-decoration:none;font-size:.75rem;border-left:3px solid transparent;transition:all .1s}
.nav-item:hover{background:var(--hover)}
.nav-item.active{background:var(--hover);border-left-color:var(--accent);font-weight:500}
.sidebar-footer{padding:.5rem;border-top:1px solid var(--border)}
.sidebar-footer button{width:100%;margin-bottom:.25rem;font-size:.7rem;padding:.4rem}
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:.5rem .8rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.main-header h2{font-weight:400;font-size:.85rem;letter-spacing:.03em}
.header-actions{display:flex;gap:.3rem;align-items:center}
.view-toggle{display:flex;border:1px solid var(--border)}
.view-toggle button{border:none;background:var(--bg);padding:.25rem .5rem;font-size:.65rem;border-right:1px solid var(--border)}
.view-toggle button:last-child{border-right:none}
.view-toggle button.active{background:var(--accent);color:var(--bg)}
.main-body{flex:1;display:flex;overflow:hidden}
.panel{display:none;flex:1;flex-direction:column;overflow:hidden}
.panel.active{display:flex}
.editor-container{flex:1;display:flex;overflow:hidden}
.code-pane{flex:1;display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border)}
.code-pane.hidden{display:none}
.preview-pane{flex:1;overflow:auto;background:#fff}
.preview-pane.hidden{display:none}
.editor-toolbar{display:flex!important;gap:4px!important;padding:8px 10px!important;background:#1e1e1e!important;border-bottom:2px solid #444!important;flex-wrap:wrap!important;align-items:center!important}
.editor-toolbar button{padding:5px 10px!important;font-size:13px!important;background:#3c3c3c!important;color:#fff!important;border:1px solid #555!important;cursor:pointer!important;border-radius:3px!important;min-width:30px!important;font-weight:600!important;line-height:1.2!important}
.editor-toolbar button:hover{background:#555!important;border-color:#888!important}
.editor-toolbar button b,.editor-toolbar button i,.editor-toolbar button u{color:#fff!important}
.editor-toolbar .sep{width:1px!important;height:20px!important;background:#555!important;margin:0 6px!important}
.cm-wrapper{flex:1;overflow:hidden}
.CodeMirror{height:100%;font-size:12px;font-family:'SF Mono',Monaco,Consolas,monospace}
.preview-content{padding:1.2rem;font-family:system-ui,-apple-system,'Avenir Next',sans-serif;font-weight:200;line-height:1.6;font-size:.95rem}
.preview-content h2,.preview-content h3{font-weight:200;letter-spacing:.12em;text-transform:uppercase;margin:1.2rem 0 .6rem}
.preview-content h2{font-size:1.3em}
.preview-content h3{font-size:1.1em}
.preview-content h2:first-child,.preview-content h3:first-child{margin-top:0}
.preview-content p{margin:0 0 .8rem}
.preview-content strong{font-weight:400;text-transform:uppercase;letter-spacing:.06em}
.preview-content em,.preview-content i{font-style:italic}
.preview-content ul,.preview-content ol{margin:0 0 .8rem;padding-left:1.3rem}
.preview-content li{margin-bottom:.4rem}
.preview-content table{width:100%;border-collapse:collapse;margin:.8rem 0}
.preview-content td,.preview-content th{padding:.4rem;vertical-align:top;border-bottom:1px solid #e0e0e0;text-align:left}
.preview-content blockquote{margin:.8rem 0;padding-left:.8rem;border-left:2px solid #000;font-style:italic}
.preview-content a{color:#000;text-decoration:underline dotted}
.preview-content small{font-size:.85em;color:#666}
.preview-content .brand-name{font-weight:400}
.seo-panel{padding:1.2rem;overflow-y:auto}
.editor-group{margin-bottom:1.2rem}
.editor-group>label{display:block;font-size:.65rem;text-transform:uppercase;letter-spacing:.05em;color:#666;margin-bottom:.3rem}
.editor-group .hint{font-size:.7rem;color:#999;margin-top:.15rem}
.section-title{font-size:.85rem;font-weight:500;margin:1.2rem 0 .8rem;padding-bottom:.3rem;border-bottom:1px solid var(--border)}
.section-title:first-child{margin-top:0}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
.char-count{font-size:.65rem;color:#999;margin-top:.15rem}
.char-count.warning{color:#f57c00}
.char-count.error{color:var(--error)}
.status-bar{position:fixed;bottom:0;left:170px;right:0;padding:.4rem .8rem;background:var(--accent);color:var(--bg);display:none;font-size:.75rem}
.status-bar.error{background:var(--error)}
.status-bar.success{background:var(--success)}
.status-bar.active{display:block}
.unsaved{display:none;width:6px;height:6px;background:orange;border-radius:50%;margin-left:.4rem}
.unsaved.active{display:inline-block}
.info-box{background:#e3f2fd;border:1px solid #90caf9;padding:.8rem;margin-bottom:.8rem;font-size:.8rem;border-radius:2px}
@media(max-width:768px){.sidebar{width:130px}.code-pane{min-width:180px}.seo-panel{padding:.8rem}.two-col{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <h1>architekturb√ºro<span>schels</span></h1>
      <p class="subtitle">Admin Panel</p>
      <form id="login-form">
        <input type="password" id="password" placeholder="Passwort" required>
        <button type="submit" style="width:100%">Anmelden</button>
        <div id="login-error" class="error"></div>
      </form>
      <div id="setup-box" style="display:none">
        <p style="margin-bottom:.6rem;font-size:.8rem">Erstes Login ‚Äì Passwort festlegen:</p>
        <input type="password" id="new-password" placeholder="Neues Passwort">
        <input type="password" id="confirm-password" placeholder="Best√§tigen">
        <button type="button" id="set-pw-btn" style="width:100%">Setzen</button>
        <div id="setup-error" class="error"></div>
      </div>
    </div>
  </div>

  <div id="admin-layout" class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-header"><h1>architekturb√ºro <span>schels</span></h1></div>
      <nav class="sidebar-nav">
        <div class="nav-section">Hauptseite</div>
        <a href="#" class="nav-item active" data-panel="profil" data-section="content1">Profil</a>
        <a href="#" class="nav-item" data-panel="vita" data-section="content2">Vita</a>
        <a href="#" class="nav-item" data-panel="leistungen" data-section="content3">Leistungen</a>
        <a href="#" class="nav-item" data-panel="projekte" data-section="content4">Projekte</a>
        <a href="#" class="nav-item" data-panel="kontakt" data-section="content5">Kontakt</a>
        <div class="nav-section">Unterseiten</div>
        <a href="#" class="nav-item" data-panel="impressum" data-file="pages/impressum.html">Impressum</a>
        <a href="#" class="nav-item" data-panel="datenschutz" data-file="pages/datenschutz.html">Datenschutz</a>
        <div class="nav-section">Einstellungen</div>
        <a href="#" class="nav-item" data-panel="seo">SEO & Meta</a>
        <a href="#" class="nav-item" data-panel="settings">GitHub</a>
      </nav>
      <div class="sidebar-footer">
        <button id="save-btn" class="btn-success">üíæ Speichern</button>
        <button id="logout-btn" class="btn-secondary">Abmelden</button>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h2 id="panel-title">Profil <span class="unsaved" id="unsaved"></span></h2>
        <div class="header-actions">
          <div class="view-toggle">
            <button data-view="split" class="active">Split</button>
            <button data-view="code">Code</button>
            <button data-view="preview">Vorschau</button>
          </div>
          <button class="btn-secondary btn-small" onclick="window.open('/','_blank')">Live ‚Üó</button>
        </div>
      </header>

      <div class="main-body">
        <!-- Editor panels generated by JS -->
        <div id="profil-panel" class="panel active" data-editor="profil"></div>
        <div id="vita-panel" class="panel" data-editor="vita"></div>
        <div id="leistungen-panel" class="panel" data-editor="leistungen"></div>
        <div id="projekte-panel" class="panel" data-editor="projekte"></div>
        <div id="kontakt-panel" class="panel" data-editor="kontakt"></div>
        <div id="impressum-panel" class="panel" data-editor="impressum"></div>
        <div id="datenschutz-panel" class="panel" data-editor="datenschutz"></div>

        <!-- SEO Panel -->
        <div id="seo-panel" class="panel">
          <div class="seo-panel">
            <div class="info-box"><strong>SEO Meta-Tags</strong> ‚Äì Beeinflusst wie deine Website in Google erscheint.</div>
            <div class="section-title">Suchmaschinen</div>
            <div class="editor-group">
              <label>Seitentitel</label>
              <input type="text" id="seo-title" oninput="charCount(this,60)">
              <div class="char-count" id="seo-title-count">0/60</div>
            </div>
            <div class="editor-group">
              <label>Beschreibung</label>
              <textarea id="seo-description" rows="2" oninput="charCount(this,160)"></textarea>
              <div class="char-count" id="seo-description-count">0/160</div>
            </div>
            <div class="editor-group">
              <label>Keywords</label>
              <textarea id="seo-keywords" rows="2"></textarea>
              <p class="hint">Kommagetrennt</p>
            </div>
            <div class="section-title">Social Media</div>
            <div class="editor-group">
              <label>OG Title</label>
              <input type="text" id="seo-og-title">
            </div>
            <div class="editor-group">
              <label>OG Description</label>
              <textarea id="seo-og-description" rows="2"></textarea>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div id="settings-panel" class="panel">
          <div class="seo-panel">
            <div class="section-title">GitHub</div>
            <div class="editor-group">
              <label>Token</label>
              <input type="password" id="github-token" placeholder="ghp_...">
              <p class="hint"><a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank">Token erstellen ‚Üí</a></p>
            </div>
            <div class="two-col">
              <div class="editor-group"><label>Repository</label><input type="text" id="github-repo" value="bschels/bschels.github.io"></div>
              <div class="editor-group"><label>Branch</label><input type="text" id="github-branch" value="main"></div>
            </div>
            <button id="test-github" class="btn-secondary">Testen</button>
            <span id="github-status" style="margin-left:.4rem;font-size:.75rem"></span>
            <div class="section-title" style="margin-top:1.5rem">Passwort</div>
            <div class="two-col">
              <div class="editor-group"><label>Aktuell</label><input type="password" id="pw-current"></div>
              <div class="editor-group"><label>Neu</label><input type="password" id="pw-new"></div>
            </div>
            <button id="change-pw" class="btn-secondary">√Ñndern</button>
            <span id="pw-status" style="margin-left:.4rem;font-size:.75rem"></span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="status-bar" class="status-bar"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
  <script>
(function(){
  const $=id=>document.getElementById(id);
  const $$=s=>document.querySelectorAll(s);
  const hash=s=>s.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0).toString(16);

  let editors={}, hasChanges=false, currentPanel='profil', currentView='split', indexHtml='';
  const editorIds=['profil','vita','leistungen','projekte','kontakt','impressum','datenschutz'];
  const sections={
    profil:{id:'content1',preserve:['.cv-header','blockquote','.cta-link']},
    vita:{id:'content2',preserve:[]},
    leistungen:{id:'content3',preserve:[]},
    projekte:{id:'content4',preserve:[]},
    kontakt:{id:'content5',preserve:['.contact-form-section']}
  };

  // Generate toolbar HTML
  function toolbarHtml(id){
    return `<div class="editor-toolbar">
      <button data-cmd="strong" title="Fett"><b>B</b></button>
      <button data-cmd="em" title="Kursiv"><i>I</i></button>
      <button data-cmd="u" title="Unterstrichen"><u>U</u></button>
      <span class="sep"></span>
      <button data-cmd="h3" title="√úberschrift">H3</button>
      <button data-cmd="p" title="Absatz">¬∂</button>
      <span class="sep"></span>
      <button data-cmd="ul" title="Liste">‚Ä¢ Liste</button>
      <button data-cmd="blockquote" title="Zitat">‚ùù</button>
      <span class="sep"></span>
      <button data-cmd="upper" title="GROSS">ABC</button>
      <button data-cmd="lower" title="klein">abc</button>
      <span class="sep"></span>
      <button data-cmd="link" title="Link">üîó</button>
      <button data-cmd="br" title="Umbruch">‚Üµ</button>
    </div>`;
  }

  // Generate editor panel HTML
  function createEditorPanels(){
    editorIds.forEach(id=>{
      const panel=$(id+'-panel');
      if(panel && panel.dataset.editor){
        panel.innerHTML=`<div class="editor-container">
          <div class="code-pane">${toolbarHtml(id)}<div class="cm-wrapper"><textarea id="editor-${id}"></textarea></div></div>
          <div class="preview-pane"><div class="preview-content" id="preview-${id}"></div></div>
        </div>`;
      }
    });
  }

  function init(){
    if(!localStorage.getItem('admin_pw')){$('login-form').style.display='none';$('setup-box').style.display='block';}
    if(sessionStorage.getItem('admin_auth'))showAdmin();
    bindEvents();
  }

  function bindEvents(){
    $('set-pw-btn').onclick=()=>{
      const pw=$('new-password').value,c=$('confirm-password').value;
      if(pw.length<4)return $('setup-error').textContent='Mind. 4 Zeichen';
      if(pw!==c)return $('setup-error').textContent='Passw√∂rter stimmen nicht √ºberein';
      localStorage.setItem('admin_pw',hash(pw));location.reload();
    };
    $('login-form').onsubmit=e=>{
      e.preventDefault();
      if(hash($('password').value)===localStorage.getItem('admin_pw')){
        sessionStorage.setItem('admin_auth','1');showAdmin();
      }else $('login-error').textContent='Falsches Passwort';
    };
    $('logout-btn').onclick=()=>{sessionStorage.removeItem('admin_auth');location.reload();};
    
    // Navigation
    $$('.nav-item').forEach(n=>n.onclick=e=>{
      e.preventDefault();
      $$('.nav-item').forEach(i=>i.classList.remove('active'));
      $$('.panel').forEach(p=>p.classList.remove('active'));
      n.classList.add('active');
      const panel=n.dataset.panel;
      $(panel+'-panel').classList.add('active');
      $('panel-title').innerHTML=n.textContent+'<span class="unsaved'+(hasChanges?' active':'')+'" id="unsaved"></span>';
      currentPanel=panel;
      if(editors[panel])setTimeout(()=>editors[panel].refresh(),10);
    });
    
    // View toggle
    $$('.view-toggle button').forEach(btn=>btn.onclick=()=>{
      $$('.view-toggle button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentView=btn.dataset.view;
      updateView();
    });
    
    // Toolbar clicks (event delegation)
    document.addEventListener('click',e=>{
      const btn=e.target.closest('.editor-toolbar button[data-cmd]');
      if(!btn)return;
      const cmd=btn.dataset.cmd;
      const toolbar=btn.closest('.editor-toolbar');
      const panel=toolbar.closest('.panel');
      const editorId=panel?.dataset.editor;
      if(!editorId||!editors[editorId])return;
      execCmd(editorId,cmd);
    });
    
    $('save-btn').onclick=saveAll;
    $('test-github').onclick=testGitHub;
    $('change-pw').onclick=changePw;
    ['seo-title','seo-description','seo-keywords','seo-og-title','seo-og-description'].forEach(id=>{
      $(id)?.addEventListener('input',markChanged);
    });
  }

  function showAdmin(){
    $('login-screen').style.display='none';
    $('admin-layout').classList.add('active');
    createEditorPanels();
    loadSettings();
    initEditors();
    loadContent();
  }

  function initEditors(){
    editorIds.forEach(id=>{
      const ta=$('editor-'+id);
      if(ta){
        editors[id]=CodeMirror.fromTextArea(ta,{
          mode:'htmlmixed',theme:'dracula',lineNumbers:true,lineWrapping:true,
          autoCloseTags:true,indentUnit:2,tabSize:2
        });
        editors[id].on('change',()=>{markChanged();updatePreview(id);});
      }
    });
  }

  function execCmd(editorId,cmd){
    const ed=editors[editorId];
    if(!ed)return;
    const sel=ed.getSelection();
    const cur=ed.getCursor();
    
    if(cmd==='upper'&&sel){ed.replaceSelection(sel.toUpperCase());}
    else if(cmd==='lower'&&sel){ed.replaceSelection(sel.toLowerCase());}
    else if(cmd==='link'){
      const url=prompt('URL:','https://');
      if(url)ed.replaceSelection(`<a href="${url}">${sel||'Link'}</a>`);
    }
    else if(cmd==='br'){ed.replaceRange('<br>\n',cur);}
    else if(cmd==='ul'){
      if(sel){
        const items=sel.split('\n').filter(l=>l.trim()).map(l=>`  <li>${l.trim()}</li>`).join('\n');
        ed.replaceSelection(`<ul>\n${items}\n</ul>`);
      }else ed.replaceSelection('<ul>\n  <li></li>\n</ul>');
    }
    else if(sel){ed.replaceSelection(`<${cmd}>${sel}</${cmd}>`);}
    else{ed.replaceRange(`<${cmd}></${cmd}>`,cur);ed.setCursor({line:cur.line,ch:cur.ch+cmd.length+2});}
    
    ed.focus();
    markChanged();
    updatePreview(editorId);
  }

  function updatePreview(id){
    const p=$('preview-'+id);
    if(p&&editors[id])p.innerHTML=editors[id].getValue();
  }

  function updateView(){
    $$('.code-pane').forEach(p=>p.classList.toggle('hidden',currentView==='preview'));
    $$('.preview-pane').forEach(p=>p.classList.toggle('hidden',currentView==='code'));
    if(editors[currentPanel])setTimeout(()=>editors[currentPanel].refresh(),10);
  }

  function loadSettings(){
    $('github-token').value=localStorage.getItem('gh_token')||'';
    $('github-repo').value=localStorage.getItem('gh_repo')||'bschels/bschels.github.io';
    $('github-branch').value=localStorage.getItem('gh_branch')||'main';
  }

  async function loadContent(){
    showStatus('Lade...');
    try{
      const res=await fetch('/index.html?t='+Date.now());
      if(!res.ok)throw new Error('index.html nicht gefunden');
      indexHtml=await res.text();
      const doc=new DOMParser().parseFromString(indexHtml,'text/html');

      // Extract sections
      Object.keys(sections).forEach(key=>{
        const sec=sections[key];
        const el=doc.getElementById(sec.id);
        if(el&&editors[key]){
          const temp=document.createElement('div');
          temp.innerHTML=el.innerHTML;
          sec.preserve.forEach(s=>temp.querySelectorAll(s).forEach(e=>e.remove()));
          temp.querySelectorAll('hr.z').forEach(hr=>hr.remove());
          editors[key].setValue(temp.innerHTML.trim());
          updatePreview(key);
        }
      });

      // Load subpages
      try{
        const imp=await fetch('/pages/impressum.html?t='+Date.now());
        if(imp.ok&&editors.impressum){editors.impressum.setValue(await imp.text());updatePreview('impressum');}
      }catch(e){}
      try{
        const ds=await fetch('/pages/datenschutz.html?t='+Date.now());
        if(ds.ok&&editors.datenschutz){editors.datenschutz.setValue(await ds.text());updatePreview('datenschutz');}
      }catch(e){}

      // SEO
      $('seo-title').value=doc.querySelector('title')?.textContent||'';
      $('seo-description').value=doc.querySelector('meta[name="description"]')?.content||'';
      $('seo-keywords').value=doc.querySelector('meta[name="keywords"]')?.content||'';
      $('seo-og-title').value=doc.querySelector('meta[property="og:title"]')?.content||'';
      $('seo-og-description').value=doc.querySelector('meta[property="og:description"]')?.content||'';
      charCount($('seo-title'),60);
      charCount($('seo-description'),160);

      hasChanges=false;
      showStatus('Geladen ‚úì','success');
      setTimeout(hideStatus,1500);
    }catch(e){
      console.error(e);
      showStatus('Fehler: '+e.message,'error');
    }
  }

  function markChanged(){
    hasChanges=true;
    $('unsaved')?.classList.add('active');
  }

  async function saveAll(){
    const btn=$('save-btn');
    btn.disabled=true;btn.textContent='Speichert...';
    showStatus('Speichert...');

    const token=localStorage.getItem('gh_token')||$('github-token').value;
    if(!token){showStatus('Token fehlt!','error');btn.disabled=false;btn.textContent='üíæ Speichern';return;}

    localStorage.setItem('gh_token',$('github-token').value);
    localStorage.setItem('gh_repo',$('github-repo').value);
    localStorage.setItem('gh_branch',$('github-branch').value);

    try{
      await saveIndexHtml();
      if(editors.impressum)await saveFile('pages/impressum.html',editors.impressum.getValue());
      if(editors.datenschutz)await saveFile('pages/datenschutz.html',editors.datenschutz.getValue());

      hasChanges=false;
      $('unsaved')?.classList.remove('active');
      showStatus('Gespeichert ‚úì','success');
      setTimeout(hideStatus,2500);
    }catch(e){
      console.error(e);
      showStatus('Fehler: '+e.message,'error');
    }
    btn.disabled=false;btn.textContent='üíæ Speichern';
  }

  async function saveIndexHtml(){
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';

    const ghRes=await fetch(`https://api.github.com/repos/${repo}/contents/index.html?ref=${branch}`,{
      headers:{Authorization:`token ${token}`}
    });
    if(!ghRes.ok)throw new Error('index.html nicht gefunden');
    const ghData=await ghRes.json();
    let html=decodeURIComponent(escape(atob(ghData.content)));

    // Update SEO
    const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const escA=s=>s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    [
      {r:/<title>[^<]*<\/title>/,v:`<title>${esc($('seo-title').value)}</title>`},
      {r:/<meta name="description" content="[^"]*"/,v:`<meta name="description" content="${escA($('seo-description').value)}"`},
      {r:/<meta name="keywords" content="[^"]*"/,v:`<meta name="keywords" content="${escA($('seo-keywords').value)}"`},
      {r:/<meta property="og:title" content="[^"]*"/,v:`<meta property="og:title" content="${escA($('seo-og-title').value)}"`},
      {r:/<meta property="og:description" content="[^"]*"/,v:`<meta property="og:description" content="${escA($('seo-og-description').value)}"`}
    ].forEach(u=>html=html.replace(u.r,u.v));

    // Update sections
    Object.keys(sections).forEach(key=>{
      if(!editors[key])return;
      const sec=sections[key];
      const regex=new RegExp(`(<div[^>]*id="${sec.id}"[^>]*>)([\\s\\S]*?)(<hr class="z">\\s*</div>)`,'i');
      const match=html.match(regex);
      if(match){
        const tempDoc=new DOMParser().parseFromString(html,'text/html');
        const orig=tempDoc.getElementById(sec.id);
        let pre='',post='';
        if(orig){
          sec.preserve.forEach(s=>{
            const el=orig.querySelector(s);
            if(el){
              if(s==='.cv-header')pre=el.outerHTML+pre;
              else post+=el.outerHTML;
            }
          });
        }
        html=html.replace(regex,`$1${pre}${editors[key].getValue()}${post}<hr class="z"></div>`);
      }
    });

    await saveFile('index.html',html,ghData.sha);
  }

  async function saveFile(path,content,sha){
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';

    if(!sha){
      try{
        const r=await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`,{
          headers:{Authorization:`token ${token}`}
        });
        if(r.ok)sha=(await r.json()).sha;
      }catch(e){}
    }

    const body={message:`Admin: ${path}`,content:btoa(unescape(encodeURIComponent(content))),branch};
    if(sha)body.sha=sha;

    const res=await fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
      method:'PUT',
      headers:{Authorization:`token ${token}`,'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    if(!res.ok){
      const err=await res.json();
      throw new Error(err.message||'GitHub Fehler');
    }
  }

  async function testGitHub(){
    const token=$('github-token').value,repo=$('github-repo').value;
    try{
      const r=await fetch(`https://api.github.com/repos/${repo}`,{headers:{Authorization:`token ${token}`}});
      if(r.ok){
        $('github-status').innerHTML='<span class="success">‚úì</span>';
        localStorage.setItem('gh_token',token);
        localStorage.setItem('gh_repo',repo);
        localStorage.setItem('gh_branch',$('github-branch').value);
      }else $('github-status').innerHTML='<span class="error">Fehler</span>';
    }catch(e){$('github-status').innerHTML='<span class="error">Fehler</span>';}
  }

  function changePw(){
    const curr=$('pw-current').value,newPw=$('pw-new').value;
    if(hash(curr)!==localStorage.getItem('admin_pw'))return $('pw-status').innerHTML='<span class="error">Falsch</span>';
    if(newPw.length<4)return $('pw-status').innerHTML='<span class="error">Mind. 4</span>';
    localStorage.setItem('admin_pw',hash(newPw));
    $('pw-status').innerHTML='<span class="success">‚úì</span>';
    $('pw-current').value='';$('pw-new').value='';
  }

  function showStatus(msg,type=''){
    const el=$('status-bar');
    el.textContent=msg;
    el.className='status-bar active'+(type?' '+type:'');
  }
  function hideStatus(){$('status-bar').classList.remove('active');}

  window.charCount=function(el,max){
    const len=el.value.length;
    const c=$(el.id+'-count');
    if(c){
      c.textContent=len+'/'+max;
      c.className='char-count'+(len>max?' error':len>max*.9?' warning':'');
    }
  };

  init();
})();
  </script>
</body>
</html>
