<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin â€“ architekturbÃ¼ro schels</title>
  <style>
:root{
  --bg:#fff;--sidebar:#fafafa;--text:#000;--border:#e0e0e0;--accent:#000;--hover:#f0f0f0;--success:#2e7d32;--error:#c62828;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.5;height:100vh;overflow:hidden}
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--sidebar)}
.login-box{background:var(--bg);padding:3rem;max-width:360px;width:100%;border:1px solid var(--border)}
.login-box h1{font-weight:200;font-size:1.3rem;letter-spacing:.2em;margin-bottom:.5rem}
.login-box h1 span{display:block;font-size:1.5rem}
.login-box .subtitle{font-size:.85rem;color:#666;margin-bottom:2rem}
input[type="password"],input[type="text"],input[type="number"],select,textarea{width:100%;padding:.6rem .8rem;border:1px solid var(--border);font-size:.9rem;font-family:inherit;margin-bottom:.6rem;background:var(--bg);color:var(--text);border-radius:0}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
textarea{min-height:80px;resize:vertical}
button{padding:.6rem 1.2rem;background:var(--accent);color:var(--bg);border:none;cursor:pointer;font-size:.85rem;letter-spacing:.02em;transition:opacity .2s;border-radius:0}
button:hover{opacity:.8}
button:disabled{opacity:.4;cursor:not-allowed}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-small{padding:.35rem .7rem;font-size:.75rem}
.btn-success{background:var(--success)}
.error{color:var(--error);font-size:.8rem;margin-top:.3rem}
.success{color:var(--success);font-size:.8rem}
.admin-layout{display:none;height:100vh}
.admin-layout.active{display:flex}
.sidebar{width:200px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-header{padding:1.2rem;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-weight:200;font-size:.9rem;letter-spacing:.12em}
.sidebar-header h1 span{font-weight:400}
.sidebar-nav{flex:1;overflow-y:auto;padding:.3rem 0}
.nav-section{padding:.5rem 1rem;font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:#999;margin-top:.8rem}
.nav-item{display:block;padding:.55rem 1.2rem;color:var(--text);text-decoration:none;font-size:.85rem;border-left:3px solid transparent;transition:all .12s}
.nav-item:hover{background:var(--hover)}
.nav-item.active{background:var(--hover);border-left-color:var(--accent);font-weight:500}
.sidebar-footer{padding:.8rem;border-top:1px solid var(--border);font-size:.75rem}
.sidebar-footer button{width:100%;margin-bottom:.4rem}
.autosave-status{color:#999;text-align:center;font-size:.7rem}
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:.8rem 1.2rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--bg)}
.main-header h2{font-weight:400;font-size:1rem;letter-spacing:.04em}
.header-actions{display:flex;gap:.4rem;align-items:center}
.main-body{flex:1;overflow-y:auto;padding:1.2rem}
.panel{display:none}
.panel.active{display:block}
.editor-group{margin-bottom:1.5rem}
.editor-group>label{display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.06em;color:#666;margin-bottom:.4rem}
.editor-group .hint{font-size:.75rem;color:#999;margin-top:.2rem}
.editor-container{border:1px solid var(--border);background:var(--bg)}
.editor-container textarea{border:none;min-height:350px}
.section-title{font-size:.9rem;font-weight:500;margin:1.5rem 0 1rem;padding-bottom:.4rem;border-bottom:1px solid var(--border)}
.section-title:first-child{margin-top:0}
.style-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.8rem;margin-bottom:1rem}
.style-item{display:flex;flex-direction:column;gap:.2rem}
.style-item label{font-size:.65rem;text-transform:uppercase;letter-spacing:.04em;color:#666}
.style-item input[type="color"]{width:100%;height:32px;padding:1px;cursor:pointer;border:1px solid var(--border)}
.style-item input[type="text"],.style-item select{padding:.45rem .6rem;font-size:.85rem}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.status-bar{position:fixed;bottom:0;left:200px;right:0;padding:.6rem 1.2rem;background:var(--accent);color:var(--bg);display:none;font-size:.85rem}
.status-bar.error{background:var(--error)}
.status-bar.success{background:var(--success)}
.status-bar.active{display:flex;justify-content:space-between;align-items:center}
.unsaved-indicator{display:none;width:8px;height:8px;background:orange;border-radius:50%;margin-left:.5rem}
.unsaved-indicator.active{display:inline-block}
/* TinyMCE Custom Styles */
.tox-tinymce{border:1px solid var(--border)!important;border-radius:0!important}
.tox .tox-edit-area__iframe{background:var(--bg)!important}
@media(max-width:768px){.sidebar{width:160px}.main-body{padding:.8rem}.style-grid{grid-template-columns:1fr}.two-col{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <h1>architekturbÃ¼ro<span>schels</span></h1>
      <p class="subtitle">Admin Panel</p>
      <form id="login-form">
        <input type="password" id="password" placeholder="Passwort" required>
        <button type="submit" style="width:100%">Anmelden</button>
        <div id="login-error" class="error"></div>
      </form>
      <div id="setup-box" style="display:none">
        <p style="margin-bottom:.8rem;font-size:.85rem">Erstes Login â€“ Passwort festlegen:</p>
        <input type="password" id="new-password" placeholder="Neues Passwort">
        <input type="password" id="confirm-password" placeholder="Passwort bestÃ¤tigen">
        <button type="button" id="set-pw-btn" style="width:100%">Passwort setzen</button>
        <div id="setup-error" class="error"></div>
      </div>
    </div>
  </div>

  <!-- Admin -->
  <div id="admin-layout" class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>architekturbÃ¼ro <span>schels</span></h1>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">Inhalte</div>
        <a href="#" class="nav-item active" data-panel="profil">Profil</a>
        <a href="#" class="nav-item" data-panel="vita">Vita</a>
        <a href="#" class="nav-item" data-panel="leistungen">Leistungen</a>
        <a href="#" class="nav-item" data-panel="referenzen">Referenzen</a>
        <a href="#" class="nav-item" data-panel="kontakt">Kontakt</a>
        <div class="nav-section">Rechtliches</div>
        <a href="#" class="nav-item" data-panel="impressum">Impressum</a>
        <a href="#" class="nav-item" data-panel="datenschutz">Datenschutz</a>
        <div class="nav-section">Design & SEO</div>
        <a href="#" class="nav-item" data-panel="seo">SEO & Meta-Tags</a>
        <div class="nav-section">System</div>
        <a href="#" class="nav-item" data-panel="einstellungen">Einstellungen</a>
      </nav>
      <div class="sidebar-footer">
        <button id="save-btn" class="btn-success">ðŸ’¾ Speichern & VerÃ¶ffentlichen</button>
        <button id="logout-btn" class="btn-secondary">Abmelden</button>
        <div class="autosave-status">Zuletzt: <span id="autosave-time">-</span></div>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h2 id="panel-title">Profil <span class="unsaved-indicator" id="unsaved"></span></h2>
        <div class="header-actions">
          <button id="preview-btn" class="btn-secondary btn-small">Vorschau â†—</button>
        </div>
      </header>

      <div class="main-body">
        <!-- Profil -->
        <div id="profil-panel" class="panel active">
          <div class="editor-group">
            <label>Profil (kompletter Inhalt)</label>
            <div class="editor-container"><textarea id="ed-profil"></textarea></div>
            <p class="hint">CV-Header und Zitat bleiben automatisch erhalten</p>
          </div>
        </div>

        <!-- Vita -->
        <div id="vita-panel" class="panel">
          <div class="editor-group">
            <label>Vita (kompletter Inhalt mit Tabelle)</label>
            <div class="editor-container"><textarea id="ed-vita"></textarea></div>
          </div>
        </div>

        <!-- Leistungen -->
        <div id="leistungen-panel" class="panel">
          <div class="editor-group">
            <label>Leistungen (kompletter Inhalt mit Listen)</label>
            <div class="editor-container"><textarea id="ed-leistungen"></textarea></div>
          </div>
        </div>

        <!-- Referenzen -->
        <div id="referenzen-panel" class="panel">
          <div class="editor-group">
            <label>Referenzen (kompletter Inhalt mit Tabelle)</label>
            <div class="editor-container"><textarea id="ed-referenzen"></textarea></div>
          </div>
        </div>

        <!-- Kontakt -->
        <div id="kontakt-panel" class="panel">
          <div class="editor-group">
            <label>Kontakt (kompletter Inhalt)</label>
            <div class="editor-container"><textarea id="ed-kontakt"></textarea></div>
            <p class="hint">Kontaktformular bleibt automatisch erhalten</p>
          </div>
        </div>

        <!-- Impressum -->
        <div id="impressum-panel" class="panel">
          <div class="editor-group">
            <label>Impressum (HTML)</label>
            <div class="editor-container"><textarea id="ed-impressum"></textarea></div>
            <p class="hint">Wird in pages/impressum.html gespeichert</p>
          </div>
        </div>

        <!-- Datenschutz -->
        <div id="datenschutz-panel" class="panel">
          <div class="editor-group">
            <label>DatenschutzerklÃ¤rung (HTML)</label>
            <div class="editor-container"><textarea id="ed-datenschutz"></textarea></div>
            <p class="hint">Wird in pages/datenschutz.html gespeichert</p>
          </div>
        </div>

        <!-- SEO -->
        <div id="seo-panel" class="panel">
          <div class="section-title">Meta-Tags</div>
          <div class="editor-group">
            <label>Seitentitel (Title Tag)</label>
            <input type="text" id="seo-title">
            <p class="hint">Empfohlen: 50-60 Zeichen</p>
          </div>
          <div class="editor-group">
            <label>Beschreibung (Meta Description)</label>
            <textarea id="seo-description"></textarea>
            <p class="hint">Empfohlen: 150-160 Zeichen</p>
          </div>
          <div class="editor-group">
            <label>Keywords</label>
            <textarea id="seo-keywords"></textarea>
            <p class="hint">Kommagetrennt</p>
          </div>
          <div class="section-title">Open Graph (Social Media)</div>
          <div class="editor-group">
            <label>OG Title</label>
            <input type="text" id="seo-og-title">
          </div>
          <div class="editor-group">
            <label>OG Description</label>
            <textarea id="seo-og-description"></textarea>
          </div>
        </div>

        <!-- Einstellungen -->
        <div id="einstellungen-panel" class="panel">
          <div class="section-title">GitHub Verbindung</div>
          <p style="font-size:.85rem;color:#666;margin-bottom:1rem">Ã„nderungen werden direkt in dein Repository geschrieben.</p>
          <div class="editor-group">
            <label>Personal Access Token</label>
            <input type="password" id="github-token" placeholder="ghp_...">
            <p class="hint"><a href="https://github.com/settings/tokens/new?scopes=repo&description=Admin%20Panel" target="_blank">Token erstellen â†’</a> (repo Berechtigung)</p>
          </div>
          <div class="two-col">
            <div class="editor-group"><label>Repository</label><input type="text" id="github-repo" value="bschels/bschels.github.io"></div>
            <div class="editor-group"><label>Branch</label><input type="text" id="github-branch" value="main"></div>
          </div>
          <button id="test-github" class="btn-secondary">Verbindung testen</button>
          <span id="github-status" style="margin-left:.5rem;font-size:.85rem"></span>

          <div class="section-title" style="margin-top:2rem">Passwort Ã¤ndern</div>
          <div class="two-col">
            <div class="editor-group"><label>Aktuelles Passwort</label><input type="password" id="pw-current"></div>
            <div class="editor-group"><label>Neues Passwort</label><input type="password" id="pw-new"></div>
          </div>
          <button id="change-pw" class="btn-secondary">Passwort Ã¤ndern</button>
          <span id="pw-status" style="margin-left:.5rem;font-size:.85rem"></span>
        </div>
      </div>
    </main>
  </div>

  <div id="status-bar" class="status-bar"></div>

  <!-- TinyMCE from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js"></script>
  <script>
(function(){
  'use strict';
  const $=id=>document.getElementById(id),$$=s=>document.querySelectorAll(s);
  const hash=s=>s.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0).toString(16);
  
  let editors={},hasChanges=false;
  
  // TinyMCE configuration - preserves ALL HTML
  const editorConfig={
    license_key:'gpl',
    promotion:false,
    branding:false,
    menubar:false,
    statusbar:true,
    min_height:350,
    // WICHTIG: Alle HTML-Elemente und Attribute erlauben
    valid_elements:'*[*]',
    valid_children:'+body[style],+div[style]',
    extended_valid_elements:'*[*]',
    custom_elements:'~small',
    // Keine automatische Bereinigung
    verify_html:false,
    cleanup:false,
    remove_trailing_brs:false,
    forced_root_block:'p',
    // Plugins fÃ¼r Listen, Tabellen, Code
    plugins:'lists table link code fullscreen',
    toolbar:'undo redo | bold italic underline | bullist numlist | table | link | code fullscreen',
    table_toolbar:'tableprops tabledelete | tableinsertrowbefore tableinsertrowafter tabledeleterow | tableinsertcolbefore tableinsertcolafter tabledeletecol',
    // Content Styling (wie Website)
    content_style:`
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Avenir Next', 'Segoe UI', sans-serif;
        font-size: 16px;
        font-weight: 200;
        line-height: 1.6;
        color: #000;
        padding: 1rem;
      }
      p { margin: 0 0 1rem; }
      h2, h3 { 
        font-weight: 200; 
        letter-spacing: 0.15em; 
        text-transform: uppercase;
        margin: 2rem 0 0.75rem;
      }
      h2 { font-size: 1.4em; }
      h3 { font-size: 1.2em; }
      h2:first-child, h3:first-child { margin-top: 0; }
      strong { font-weight: 400; text-transform: uppercase; letter-spacing: 0.08em; }
      em, i { font-style: italic; }
      ul, ol { margin: 0 0 1rem; padding-left: 1.5rem; }
      li { margin-bottom: 0.5rem; }
      table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
      td, th { padding: 0.5rem; vertical-align: top; border-bottom: 1px solid #e0e0e0; text-align: left; }
      blockquote { margin: 1rem 0; padding-left: 1rem; border-left: 2px solid #000; font-style: italic; }
      a { color: #000; text-decoration: underline; text-decoration-style: dotted; }
      .brand-name { font-weight: 400; }
      small { font-size: 0.85em; color: #666; }
    `,
    setup:ed=>{
      ed.on('change',()=>markChanged());
      ed.on('input',()=>markChanged());
    }
  };
  
  // Init
  function init(){
    if(!localStorage.getItem('admin_pw')){$('login-form').style.display='none';$('setup-box').style.display='block';}
    if(sessionStorage.getItem('admin_auth'))showAdmin();
    bindEvents();
  }
  
  function bindEvents(){
    $('set-pw-btn').onclick=()=>{
      const pw=$('new-password').value,c=$('confirm-password').value;
      if(pw.length<4)return $('setup-error').textContent='Mind. 4 Zeichen';
      if(pw!==c)return $('setup-error').textContent='PasswÃ¶rter stimmen nicht Ã¼berein';
      localStorage.setItem('admin_pw',hash(pw));location.reload();
    };
    $('login-form').onsubmit=e=>{
      e.preventDefault();
      if(hash($('password').value)===localStorage.getItem('admin_pw')){
        sessionStorage.setItem('admin_auth','1');showAdmin();
      }else $('login-error').textContent='Falsches Passwort';
    };
    $('logout-btn').onclick=()=>{sessionStorage.removeItem('admin_auth');location.reload();};
    $$('.nav-item').forEach(n=>n.onclick=e=>{
      e.preventDefault();
      $$('.nav-item').forEach(i=>i.classList.remove('active'));
      $$('.panel').forEach(p=>p.classList.remove('active'));
      n.classList.add('active');
      $(n.dataset.panel+'-panel').classList.add('active');
      $('panel-title').innerHTML=n.textContent+'<span class="unsaved-indicator'+(hasChanges?' active':'')+'"></span>';
    });
    $('save-btn').onclick=saveAll;
    $('preview-btn').onclick=()=>window.open('/','_blank');
    $('test-github').onclick=testGitHub;
    $('change-pw').onclick=changePw;
  }
  
  function showAdmin(){
    $('login-screen').style.display='none';
    $('admin-layout').classList.add('active');
    loadSettings();
    initEditors();
  }
  
  async function initEditors(){
    showStatus('Initialisiere Editoren...');
    
    const editorIds=['ed-profil','ed-vita','ed-leistungen','ed-referenzen','ed-kontakt','ed-impressum','ed-datenschutz'];
    
    for(const id of editorIds){
      const el=$(id);
      if(el){
        await tinymce.init({
          ...editorConfig,
          selector:'#'+id
        });
        const name=id.replace('ed-','');
        editors[name]=tinymce.get(id);
      }
    }
    
    // Load content after editors are ready
    await loadContent();
    
    // Mark other inputs for change tracking
    $$('input,textarea,select').forEach(el=>{
      if(!el.id.startsWith('ed-'))el.addEventListener('input',markChanged);
    });
  }
  
  function markChanged(){
    hasChanges=true;
    $('unsaved')?.classList.add('active');
  }
  
  function loadSettings(){
    $('github-token').value=localStorage.getItem('gh_token')||'';
    $('github-repo').value=localStorage.getItem('gh_repo')||'bschels/bschels.github.io';
    $('github-branch').value=localStorage.getItem('gh_branch')||'main';
  }
  
  async function loadContent(){
    showStatus('Lade Inhalte...');
    try{
      // Load index.html
      const indexRes=await fetch('/index.html?t='+Date.now());
      if(!indexRes.ok)throw new Error('index.html nicht gefunden');
      const indexHtml=await indexRes.text();
      const doc=new DOMParser().parseFromString(indexHtml,'text/html');
      
      extractFromDoc(doc);
      
      // Load impressum
      try{
        const impRes=await fetch('/pages/impressum.html?t='+Date.now());
        if(impRes.ok && editors.impressum){
          editors.impressum.setContent(await impRes.text());
        }
      }catch(e){console.log('Impressum nicht geladen:',e);}
      
      // Load datenschutz
      try{
        const dsRes=await fetch('/pages/datenschutz.html?t='+Date.now());
        if(dsRes.ok && editors.datenschutz){
          editors.datenschutz.setContent(await dsRes.text());
        }
      }catch(e){console.log('Datenschutz nicht geladen:',e);}
      
      // Load SEO
      $('seo-title').value=doc.querySelector('title')?.textContent||'';
      $('seo-description').value=doc.querySelector('meta[name="description"]')?.content||'';
      $('seo-keywords').value=doc.querySelector('meta[name="keywords"]')?.content||'';
      $('seo-og-title').value=doc.querySelector('meta[property="og:title"]')?.content||'';
      $('seo-og-description').value=doc.querySelector('meta[property="og:description"]')?.content||'';
      
      hasChanges=false;
      showStatus('Inhalte geladen âœ“','success');
      setTimeout(hideStatus,2000);
    }catch(e){
      console.error(e);
      showStatus('Fehler beim Laden: '+e.message,'error');
    }
  }
  
  function extractFromDoc(doc){
    // Profil - content between cv-header and blockquote/cta
    const profil=doc.querySelector('#content1');
    if(profil && editors.profil){
      let html='';
      profil.querySelectorAll('h3,p,ul,ol').forEach(el=>{
        // Skip special elements
        if(el.classList.contains('cv-role')||el.classList.contains('cv-subtitle')||
           el.classList.contains('cta-link')||el.classList.contains('says'))return;
        if(el.closest('.cv-header')||el.closest('blockquote'))return;
        html+=el.outerHTML;
      });
      editors.profil.setContent(html);
    }
    
    // Vita - full table and content
    const vita=doc.querySelector('#content2');
    if(vita && editors.vita){
      let html='';
      vita.querySelectorAll('table,p,h3,ul,ol').forEach(el=>{
        html+=el.outerHTML;
      });
      editors.vita.setContent(html);
    }
    
    // Leistungen - all content with lists
    const leist=doc.querySelector('#content3');
    if(leist && editors.leistungen){
      let html='';
      leist.querySelectorAll('h3,p,ul,ol,blockquote').forEach(el=>{
        html+=el.outerHTML;
      });
      editors.leistungen.setContent(html);
    }
    
    // Referenzen - table and content
    const refs=doc.querySelector('#content4');
    if(refs && editors.referenzen){
      let html='';
      refs.querySelectorAll('h3,table,p,ul,ol,small').forEach(el=>{
        html+=el.outerHTML;
      });
      editors.referenzen.setContent(html);
    }
    
    // Kontakt - intro and contact info
    const kontakt=doc.querySelector('#content5');
    if(kontakt && editors.kontakt){
      let html='';
      const intro=kontakt.querySelector('p.content');
      const info=kontakt.querySelector('.contact-info');
      if(intro)html+=intro.outerHTML;
      if(info)html+=info.outerHTML;
      editors.kontakt.setContent(html);
    }
  }
  
  async function saveAll(){
    const btn=$('save-btn');
    btn.disabled=true;btn.textContent='Speichert...';
    showStatus('Speichert...');
    
    const token=localStorage.getItem('gh_token')||$('github-token').value;
    if(!token){
      showStatus('GitHub Token fehlt! Bitte unter Einstellungen eingeben.','error');
      btn.disabled=false;btn.textContent='ðŸ’¾ Speichern & VerÃ¶ffentlichen';
      return;
    }
    
    // Save settings
    localStorage.setItem('gh_token',$('github-token').value);
    localStorage.setItem('gh_repo',$('github-repo').value);
    localStorage.setItem('gh_branch',$('github-branch').value);
    
    try{
      // 1. Save index.html with all content sections
      await saveIndexHtml();
      
      // 2. Save impressum
      if(editors.impressum){
        await saveFile('pages/impressum.html',editors.impressum.getContent());
      }
      
      // 3. Save datenschutz
      if(editors.datenschutz){
        await saveFile('pages/datenschutz.html',editors.datenschutz.getContent());
      }
      
      hasChanges=false;
      $('unsaved')?.classList.remove('active');
      $('autosave-time').textContent=new Date().toLocaleTimeString('de');
      showStatus('Gespeichert & verÃ¶ffentlicht âœ“','success');
      setTimeout(hideStatus,3000);
    }catch(e){
      console.error('Save error:',e);
      showStatus('Fehler: '+e.message,'error');
    }
    btn.disabled=false;btn.textContent='ðŸ’¾ Speichern & VerÃ¶ffentlichen';
  }
  
  async function saveIndexHtml(){
    console.log('saveIndexHtml: Start');
    
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';
    
    // Fetch current index.html from GitHub
    const ghRes=await fetch(`https://api.github.com/repos/${repo}/contents/index.html?ref=${branch}`,{
      headers:{Authorization:`token ${token}`}
    });
    if(!ghRes.ok)throw new Error('index.html nicht gefunden auf GitHub');
    const ghData=await ghRes.json();
    let html=decodeURIComponent(escape(atob(ghData.content)));
    console.log('saveIndexHtml: Fetched, length='+html.length);
    
    const doc=new DOMParser().parseFromString(html,'text/html');
    
    // Update SEO meta tags
    const title=doc.querySelector('title');
    if(title && $('seo-title').value)title.textContent=$('seo-title').value;
    
    const desc=doc.querySelector('meta[name="description"]');
    if(desc && $('seo-description').value)desc.setAttribute('content',$('seo-description').value);
    
    const keywords=doc.querySelector('meta[name="keywords"]');
    if(keywords && $('seo-keywords').value)keywords.setAttribute('content',$('seo-keywords').value);
    
    const ogTitle=doc.querySelector('meta[property="og:title"]');
    if(ogTitle && $('seo-og-title').value)ogTitle.setAttribute('content',$('seo-og-title').value);
    
    const ogDesc=doc.querySelector('meta[property="og:description"]');
    if(ogDesc && $('seo-og-description').value)ogDesc.setAttribute('content',$('seo-og-description').value);
    
    // Update Profil (content1) - preserve cv-header and blockquote
    const profil=doc.querySelector('#content1');
    if(profil && editors.profil){
      const cvHeader=profil.querySelector('.cv-header');
      const blockquote=profil.querySelector('blockquote');
      const cta=profil.querySelector('.cta-link');
      
      let newContent='';
      if(cvHeader)newContent+=cvHeader.outerHTML;
      newContent+=editors.profil.getContent();
      if(blockquote)newContent+=blockquote.outerHTML;
      if(cta)newContent+=cta.outerHTML;
      newContent+='<hr class="z">';
      profil.innerHTML=newContent;
    }
    
    // Update Vita (content2)
    const vita=doc.querySelector('#content2');
    if(vita && editors.vita){
      vita.innerHTML=editors.vita.getContent()+'<hr class="z">';
    }
    
    // Update Leistungen (content3)
    const leist=doc.querySelector('#content3');
    if(leist && editors.leistungen){
      leist.innerHTML=editors.leistungen.getContent()+'<hr class="z">';
    }
    
    // Update Referenzen (content4)
    const refs=doc.querySelector('#content4');
    if(refs && editors.referenzen){
      refs.innerHTML=editors.referenzen.getContent()+'<hr class="z">';
    }
    
    // Update Kontakt (content5) - preserve contact form
    const kontakt=doc.querySelector('#content5');
    if(kontakt && editors.kontakt){
      const formSection=kontakt.querySelector('.contact-form-section');
      let newContent='<div>'+editors.kontakt.getContent();
      if(formSection)newContent+=formSection.outerHTML;
      newContent+='<hr class="z"></div>';
      kontakt.innerHTML=newContent;
    }
    
    // Serialize back to HTML
    let newHtml='<!DOCTYPE html>\n'+doc.documentElement.outerHTML;
    newHtml=newHtml.replace(/ xmlns="[^"]*"/g,'');
    console.log('saveIndexHtml: Serialized, length='+newHtml.length);
    
    await saveFile('index.html',newHtml);
    console.log('saveIndexHtml: Saved');
  }
  
  async function saveFile(path,content,retry=true){
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';
    
    // Get fresh SHA
    let sha;
    try{
      const r=await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}&t=${Date.now()}`,{
        headers:{Authorization:`token ${token}`},
        cache:'no-store'
      });
      if(r.ok)sha=(await r.json()).sha;
    }catch(e){}
    
    const body={
      message:`Admin: ${path} aktualisiert`,
      content:btoa(unescape(encodeURIComponent(content))),
      branch
    };
    if(sha)body.sha=sha;
    
    const res=await fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
      method:'PUT',
      headers:{Authorization:`token ${token}`,'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    
    if(!res.ok){
      const errData=await res.json();
      if(res.status===409 && retry){
        console.log('SHA conflict, retrying...');
        return saveFile(path,content,false);
      }
      throw new Error(errData.message||'GitHub Fehler');
    }
  }
  
  async function testGitHub(){
    const token=$('github-token').value;
    const repo=$('github-repo').value;
    try{
      const r=await fetch(`https://api.github.com/repos/${repo}`,{headers:{Authorization:`token ${token}`}});
      if(r.ok){
        $('github-status').innerHTML='<span class="success">âœ“ Verbunden</span>';
        localStorage.setItem('gh_token',token);
        localStorage.setItem('gh_repo',repo);
        localStorage.setItem('gh_branch',$('github-branch').value);
      }else{
        $('github-status').innerHTML='<span class="error">Fehler '+r.status+'</span>';
      }
    }catch(e){
      $('github-status').innerHTML='<span class="error">Verbindungsfehler</span>';
    }
  }
  
  function changePw(){
    const curr=$('pw-current').value,newPw=$('pw-new').value;
    if(hash(curr)!==localStorage.getItem('admin_pw')){
      return $('pw-status').innerHTML='<span class="error">Falsches Passwort</span>';
    }
    if(newPw.length<4){
      return $('pw-status').innerHTML='<span class="error">Mind. 4 Zeichen</span>';
    }
    localStorage.setItem('admin_pw',hash(newPw));
    $('pw-status').innerHTML='<span class="success">âœ“ GeÃ¤ndert</span>';
    $('pw-current').value='';$('pw-new').value='';
  }
  
  function showStatus(msg,type=''){
    const el=$('status-bar');
    el.textContent=msg;
    el.className='status-bar active'+(type?' '+type:'');
  }
  function hideStatus(){$('status-bar').classList.remove('active');}
  
  init();
})();
  </script>
</body>
</html>
