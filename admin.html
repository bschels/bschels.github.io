<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin ‚Äì architekturb√ºro schels</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
  <style>
:root{--bg:#fff;--sidebar:#fafafa;--text:#000;--border:#e0e0e0;--accent:#000;--hover:#f0f0f0;--success:#2e7d32;--error:#c62828}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;height:100vh;overflow:hidden}
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--sidebar)}
.login-box{background:var(--bg);padding:2.5rem;max-width:340px;width:100%;border:1px solid var(--border)}
.login-box h1{font-weight:200;font-size:1.2rem;letter-spacing:.15em;margin-bottom:.4rem}
.login-box h1 span{display:block;font-size:1.4rem}
.login-box .subtitle{font-size:.8rem;color:#666;margin-bottom:1.5rem}
input[type="password"],input[type="text"],select,textarea{width:100%;padding:.5rem .7rem;border:1px solid var(--border);font-size:.85rem;font-family:inherit;margin-bottom:.5rem;background:var(--bg);color:var(--text);border-radius:0}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
textarea{min-height:70px;resize:vertical}
button{padding:.5rem 1rem;background:var(--accent);color:var(--bg);border:none;cursor:pointer;font-size:.8rem;letter-spacing:.02em;transition:opacity .15s;border-radius:0}
button:hover{opacity:.8}
button:disabled{opacity:.4;cursor:not-allowed}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-small{padding:.3rem .6rem;font-size:.7rem}
.btn-success{background:var(--success)}
.error{color:var(--error);font-size:.75rem;margin-top:.2rem}
.success{color:var(--success);font-size:.75rem}
.admin-layout{display:none;height:100vh}
.admin-layout.active{display:flex}
.sidebar{width:170px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.sidebar-header{padding:.8rem;border-bottom:1px solid var(--border)}
.sidebar-header h1{font-weight:200;font-size:.75rem;letter-spacing:.08em}
.sidebar-header h1 span{font-weight:400}
.sidebar-nav{flex:1;overflow-y:auto;padding:.2rem 0}
.nav-section{padding:.3rem .7rem;font-size:.55rem;text-transform:uppercase;letter-spacing:.06em;color:#999;margin-top:.5rem}
.nav-item{display:block;padding:.4rem .8rem;color:var(--text);text-decoration:none;font-size:.75rem;border-left:3px solid transparent;transition:all .1s}
.nav-item:hover{background:var(--hover)}
.nav-item.active{background:var(--hover);border-left-color:var(--accent);font-weight:500}
.sidebar-footer{padding:.5rem;border-top:1px solid var(--border)}
.sidebar-footer button{width:100%;margin-bottom:.25rem;font-size:.7rem;padding:.4rem}
.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-header{padding:.5rem .8rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.main-header h2{font-weight:400;font-size:.85rem;letter-spacing:.03em}
.header-actions{display:flex;gap:.3rem;align-items:center}
.view-toggle{display:flex;border:1px solid var(--border)}
.view-toggle button{border:none;background:var(--bg);padding:.25rem .5rem;font-size:.65rem;border-right:1px solid var(--border)}
.view-toggle button:last-child{border-right:none}
.view-toggle button.active{background:var(--accent);color:var(--bg)}
.main-body{flex:1;display:flex;overflow:hidden}
.panel{display:none;flex:1;flex-direction:column;overflow:hidden}
.panel.active{display:flex}
.editor-container{flex:1;display:flex;overflow:hidden}
.code-pane{flex:1;display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border)}
.code-pane.hidden{display:none}
.preview-pane{flex:1;overflow:auto;background:#fff}
.preview-pane.hidden{display:none}
.editor-toolbar{display:flex!important;gap:4px!important;padding:8px 10px!important;background:#1e1e1e!important;border-bottom:2px solid #444!important;flex-wrap:wrap!important;align-items:center!important}
.editor-toolbar button{padding:5px 10px!important;font-size:13px!important;background:#3c3c3c!important;color:#fff!important;border:1px solid #555!important;cursor:pointer!important;border-radius:3px!important;min-width:30px!important;font-weight:600!important;line-height:1.2!important}
.editor-toolbar button:hover{background:#555!important;border-color:#888!important}
.editor-toolbar button b,.editor-toolbar button i,.editor-toolbar button u{color:#fff!important}
.editor-toolbar .sep{width:1px!important;height:20px!important;background:#555!important;margin:0 6px!important}
.cm-wrapper{flex:1;overflow:hidden}
.CodeMirror{height:100%;font-size:12px;font-family:'SF Mono',Monaco,Consolas,monospace}
.preview-content{padding:1.2rem;font-family:system-ui,-apple-system,'Avenir Next',sans-serif;font-weight:200;line-height:1.6;font-size:.95rem}
.preview-content h2,.preview-content h3{font-weight:200;letter-spacing:.12em;text-transform:uppercase;margin:1.2rem 0 .6rem}
.preview-content h2{font-size:1.3em}
.preview-content h3{font-size:1.1em}
.preview-content h2:first-child,.preview-content h3:first-child{margin-top:0}
.preview-content p{margin:0 0 .8rem}
.preview-content strong{font-weight:400;text-transform:uppercase;letter-spacing:.06em}
.preview-content em,.preview-content i{font-style:italic}
.preview-content ul,.preview-content ol{margin:0 0 .8rem;padding-left:1.3rem}
.preview-content li{margin-bottom:.4rem}
.preview-content table{width:100%;border-collapse:collapse;margin:.8rem 0}
.preview-content td,.preview-content th{padding:.4rem;vertical-align:top;border-bottom:1px solid #e0e0e0;text-align:left}
.preview-content blockquote{margin:.8rem 0;padding-left:.8rem;border-left:2px solid #000;font-style:italic}
.preview-content a{color:#000;text-decoration:underline dotted}
.preview-content small{font-size:.85em;color:#666}
.preview-content .brand-name{font-weight:400}
.seo-panel{padding:1.2rem;overflow-y:auto}
.editor-group{margin-bottom:1.2rem}
.editor-group>label{display:block;font-size:.65rem;text-transform:uppercase;letter-spacing:.05em;color:#666;margin-bottom:.3rem}
.editor-group .hint{font-size:.7rem;color:#999;margin-top:.15rem}
.section-title{font-size:.85rem;font-weight:500;margin:1.2rem 0 .8rem;padding-bottom:.3rem;border-bottom:1px solid var(--border)}
.section-title:first-child{margin-top:0}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
.char-count{font-size:.65rem;color:#999;margin-top:.15rem}
.char-count.warning{color:#f57c00}
.char-count.error{color:var(--error)}
.status-bar{position:fixed;bottom:0;left:170px;right:0;padding:.4rem .8rem;background:var(--accent);color:var(--bg);display:none;font-size:.75rem}
.status-bar.error{background:var(--error)}
.status-bar.success{background:var(--success)}
.status-bar.active{display:block}
.unsaved{display:none;width:6px;height:6px;background:orange;border-radius:50%;margin-left:.4rem}
.unsaved.active{display:inline-block}
.info-box{background:#e3f2fd;border:1px solid #90caf9;padding:.8rem;margin-bottom:.8rem;font-size:.8rem;border-radius:2px}
@media(max-width:768px){.sidebar{width:130px}.code-pane{min-width:180px}.seo-panel{padding:.8rem}.two-col{grid-template-columns:1fr}}
.css-quick-bar{display:flex;gap:1rem;padding:8px 12px;background:#1e1e1e;border-bottom:1px solid #444;flex-wrap:wrap;align-items:center}
.css-var-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.css-var-group .var-label{color:#999;font-size:11px;text-transform:uppercase;letter-spacing:.05em}
.css-var-group label{display:flex;align-items:center;gap:3px;cursor:pointer}
.css-var-group label span{color:#ccc;font-size:10px}
.css-var-group input[type="color"]{width:24px;height:24px;border:2px solid #444;border-radius:4px;cursor:pointer;padding:0;background:none}
.css-var-group input[type="color"]::-webkit-color-swatch-wrapper{padding:2px}
.css-var-group input[type="color"]::-webkit-color-swatch{border-radius:2px;border:none}
.preview-size{padding:4px 8px;font-size:10px;background:#333;color:#ccc;border:1px solid #555;cursor:pointer;border-radius:3px}
.preview-size:hover{background:#444}
.preview-size.active{background:#666;color:#fff;border-color:#888}
#dark-mode-toggle{padding:4px 8px;font-size:14px;background:#333;border:1px solid #555;cursor:pointer;border-radius:3px}
#dark-mode-toggle.active{background:#fff;color:#000}
.image-card{border:1px solid var(--border);padding:.5rem;cursor:pointer;transition:all .15s}
.image-card:hover{border-color:var(--accent);background:var(--hover)}
.image-card img{width:100%;height:80px;object-fit:cover;background:#f0f0f0}
.image-card .name{font-size:.65rem;margin-top:.3rem;word-break:break-all;color:#666}
.image-card .delete-img{position:absolute;top:2px;right:2px;background:rgba(200,0,0,.8);color:#fff;border:none;width:18px;height:18px;font-size:10px;cursor:pointer;border-radius:2px;display:none}
.image-card:hover .delete-img{display:block}
.diff-add{background:#e6ffe6;color:#006600}
.diff-remove{background:#ffe6e6;color:#cc0000;text-decoration:line-through}
.diff-file{font-weight:600;margin:1rem 0 .5rem;padding:.3rem;background:#e0e0e0}
.stat-card{background:var(--sidebar);border:1px solid var(--border);padding:1rem;margin-bottom:.8rem}
.stat-card h4{margin:0 0 .5rem;font-size:.8rem;color:#666;font-weight:400}
.stat-card .value{font-size:1.8rem;font-weight:300}
.stat-row{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid var(--border);font-size:.8rem}
.stat-row:last-child{border:none}
.keyboard-hint{font-size:.6rem;color:#999;margin-top:.3rem}
  </style>
</head>
<body>
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <h1>architekturb√ºro<span>schels</span></h1>
      <p class="subtitle">Admin Panel</p>
      <form id="login-form">
        <input type="password" id="password" placeholder="Passwort" required>
        <button type="submit" style="width:100%">Anmelden</button>
        <div id="login-error" class="error"></div>
      </form>
      <div id="setup-box" style="display:none">
        <p style="margin-bottom:.6rem;font-size:.8rem">Erstes Login ‚Äì Passwort festlegen:</p>
        <input type="password" id="new-password" placeholder="Neues Passwort">
        <input type="password" id="confirm-password" placeholder="Best√§tigen">
        <button type="button" id="set-pw-btn" style="width:100%">Setzen</button>
        <div id="setup-error" class="error"></div>
      </div>
    </div>
  </div>

  <div id="admin-layout" class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-header"><h1>architekturb√ºro <span>schels</span></h1></div>
      <nav class="sidebar-nav">
        <div class="nav-section">Hauptseite</div>
        <a href="#" class="nav-item active" data-panel="profil" data-section="content1">Profil</a>
        <a href="#" class="nav-item" data-panel="leistungen" data-section="content3">Leistungen</a>
        <a href="#" class="nav-item" data-panel="projekte" data-section="content4">Projekte</a>
        <a href="#" class="nav-item" data-panel="kontakt" data-section="content5">Kontakt</a>
        <a href="#" class="nav-item" data-panel="vita">Vita (Lightbox)</a>
        <div class="nav-section">Unterseiten</div>
        <a href="#" class="nav-item" data-panel="impressum" data-file="pages/impressum.html">Impressum</a>
        <a href="#" class="nav-item" data-panel="datenschutz" data-file="pages/datenschutz.html">Datenschutz</a>
        <div class="nav-section">Einstellungen</div>
        <a href="#" class="nav-item" data-panel="seo">SEO & Meta</a>
        <a href="#" class="nav-item" data-panel="styles">Styles</a>
        <a href="#" class="nav-item" data-panel="images">Bilder</a>
        <a href="#" class="nav-item" data-panel="stats">Statistiken</a>
        <a href="#" class="nav-item" data-panel="settings">GitHub</a>
      </nav>
      <div class="sidebar-footer">
        <button id="diff-btn" class="btn-secondary" onclick="showDiff()" style="font-size:.65rem">üîç √Ñnderungen</button>
        <button id="save-btn" class="btn-success">üíæ Speichern</button>
        <button id="logout-btn" class="btn-secondary">Abmelden</button>
      </div>
    </aside>

    <main class="main-content">
      <header class="main-header">
        <h2 id="panel-title">Profil <span class="unsaved" id="unsaved"></span></h2>
        <div class="header-actions">
          <div class="view-toggle">
            <button data-view="split" class="active">Split</button>
            <button data-view="code">Code</button>
            <button data-view="preview">Vorschau</button>
          </div>
          <button class="btn-secondary btn-small" onclick="window.open('/','_blank')">Live ‚Üó</button>
        </div>
      </header>

      <div class="main-body">
        <!-- Editor panels generated by JS -->
        <div id="profil-panel" class="panel active" data-editor="profil"></div>
        <div id="leistungen-panel" class="panel" data-editor="leistungen"></div>
        <div id="projekte-panel" class="panel" data-editor="projekte"></div>
        <div id="kontakt-panel" class="panel" data-editor="kontakt"></div>
        <div id="vita-panel" class="panel" data-editor="vita"></div>
        <div id="impressum-panel" class="panel" data-editor="impressum"></div>
        <div id="datenschutz-panel" class="panel" data-editor="datenschutz"></div>

        <!-- SEO Panel -->
        <div id="seo-panel" class="panel">
          <div class="seo-panel">
            <div class="info-box"><strong>SEO Meta-Tags</strong> ‚Äì Beeinflusst wie deine Website in Google erscheint.</div>
            <div class="section-title">Suchmaschinen</div>
            <div class="editor-group">
              <label>Seitentitel</label>
              <input type="text" id="seo-title" oninput="charCount(this,60)">
              <div class="char-count" id="seo-title-count">0/60</div>
            </div>
            <div class="editor-group">
              <label>Beschreibung</label>
              <textarea id="seo-description" rows="2" oninput="charCount(this,160)"></textarea>
              <div class="char-count" id="seo-description-count">0/160</div>
            </div>
            <div class="editor-group">
              <label>Keywords</label>
              <textarea id="seo-keywords" rows="2"></textarea>
              <p class="hint">Kommagetrennt</p>
            </div>
            <div class="section-title">Social Media</div>
            <div class="editor-group">
              <label>OG Title</label>
              <input type="text" id="seo-og-title">
            </div>
            <div class="editor-group">
              <label>OG Description</label>
              <textarea id="seo-og-description" rows="2"></textarea>
            </div>
          </div>
        </div>

        <!-- Styles Panel -->
        <div id="styles-panel" class="panel">
          <div class="editor-container" style="flex-direction:column">
            <!-- Quick Edit Bar -->
            <div class="css-quick-bar">
              <div class="css-var-group">
                <span class="var-label">Farben:</span>
                <label title="Hintergrund"><input type="color" id="var-bg" value="#ffffff"><span>BG</span></label>
                <label title="Text"><input type="color" id="var-body" value="#000000"><span>Text</span></label>
                <label title="Sekund√§r"><input type="color" id="var-secondary" value="#555555"><span>2nd</span></label>
                <label title="Akzent"><input type="color" id="var-accent" value="#0000ff"><span>Akzent</span></label>
                <label title="Hover BG"><input type="color" id="var-hover-bg" value="#000000"><span>Hover</span></label>
                <label title="Hover Text"><input type="color" id="var-hover-text" value="#ffffff"><span>H-Text</span></label>
              </div>
              <div class="css-var-group">
                <span class="var-label">Vorschau:</span>
                <button class="preview-size active" data-width="100%">Desktop</button>
                <button class="preview-size" data-width="768px">Tablet</button>
                <button class="preview-size" data-width="375px">Mobile</button>
                <button id="dark-mode-toggle" title="Dark Mode testen">üåô</button>
              </div>
            </div>
            <!-- Simple Split View: Code + Preview -->
            <div style="display:flex;flex:1;overflow:hidden">
              <div class="code-pane" style="flex:1;border-right:1px solid var(--border)">
                <div class="cm-wrapper"><textarea id="editor-styles"></textarea></div>
              </div>
              <div class="preview-pane" style="flex:1;display:flex;justify-content:center;background:#e0e0e0;padding:1rem">
                <iframe id="styles-preview" src="/" style="width:100%;height:100%;border:none;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.15);transition:width .3s"></iframe>
              </div>
            </div>
          </div>
        </div>

        <!-- Images Panel -->
        <div id="images-panel" class="panel">
          <div class="seo-panel">
            <div class="section-title">Bilder verwalten</div>
            <div class="info-box">Bilder im <code>/images/</code> Ordner. Klicke zum Kopieren des Pfads.</div>
            <div id="images-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:1rem;margin-top:1rem"></div>
            <div class="section-title" style="margin-top:1.5rem">Bild hochladen</div>
            <div class="editor-group">
              <input type="file" id="image-upload" accept="image/*" style="margin-bottom:.5rem">
              <button id="upload-image-btn" class="btn-secondary">Hochladen</button>
              <span id="upload-status" style="margin-left:.5rem;font-size:.75rem"></span>
            </div>
          </div>
        </div>

        <!-- Stats Panel -->
        <div id="stats-panel" class="panel">
          <div class="seo-panel">
            <div class="section-title">Besucherstatistiken</div>
            <div class="editor-group">
              <label>GoatCounter API Token</label>
              <input type="password" id="goat-token" placeholder="Token eingeben...">
              <p class="hint"><a href="https://schels.goatcounter.com/user/api" target="_blank">API Token erstellen ‚Üí</a></p>
            </div>
            <div id="stats-container" style="margin-top:1rem">
              <p style="color:#666">Token eingeben f√ºr Statistiken</p>
            </div>
            <div style="margin-top:1rem;display:flex;gap:.5rem">
              <button id="refresh-stats" class="btn-secondary">üîÑ Laden</button>
              <a href="https://schels.goatcounter.com" target="_blank" class="btn-secondary" style="text-decoration:none">üìä Dashboard √∂ffnen ‚Üí</a>
            </div>
          </div>
        </div>

        <!-- Diff Panel (Modal) -->
        <div id="diff-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);z-index:100;padding:2rem;overflow:auto">
          <div style="max-width:900px;margin:0 auto;background:#fff;border-radius:4px;padding:1.5rem">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
              <h3 style="margin:0;font-weight:500">√Ñnderungen √ºberpr√ºfen</h3>
              <button id="close-diff" class="btn-secondary btn-small">‚úï Schlie√üen</button>
            </div>
            <div id="diff-content" style="font-family:monospace;font-size:12px;max-height:60vh;overflow:auto;background:#f5f5f5;padding:1rem;border-radius:4px"></div>
            <div style="margin-top:1rem;display:flex;gap:.5rem;justify-content:flex-end">
              <button id="diff-cancel" class="btn-secondary">Abbrechen</button>
              <button id="diff-save" class="btn-success">üíæ Speichern</button>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div id="settings-panel" class="panel">
          <div class="seo-panel">
            <div class="section-title">GitHub</div>
            <div class="editor-group">
              <label>Token</label>
              <input type="password" id="github-token" placeholder="ghp_...">
              <p class="hint"><a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank">Token erstellen ‚Üí</a></p>
            </div>
            <div class="two-col">
              <div class="editor-group"><label>Repository</label><input type="text" id="github-repo" value="bschels/bschels.github.io"></div>
              <div class="editor-group"><label>Branch</label><input type="text" id="github-branch" value="main"></div>
            </div>
            <button id="test-github" class="btn-secondary">Testen</button>
            <span id="github-status" style="margin-left:.4rem;font-size:.75rem"></span>
            <div class="section-title" style="margin-top:1.5rem">Passwort</div>
            <div class="two-col">
              <div class="editor-group"><label>Aktuell</label><input type="password" id="pw-current"></div>
              <div class="editor-group"><label>Neu</label><input type="password" id="pw-new"></div>
            </div>
            <button id="change-pw" class="btn-secondary">√Ñndern</button>
            <span id="pw-status" style="margin-left:.4rem;font-size:.75rem"></span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="status-bar" class="status-bar"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closetag.min.js"></script>
  <script>
(function(){
  const $=id=>document.getElementById(id);
  const $$=s=>document.querySelectorAll(s);
  const hash=s=>s.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0).toString(16);

  let editors={}, hasChanges=false, currentPanel='profil', currentView='split', indexHtml='', cssEditor=null;
  const editorIds=['profil','leistungen','projekte','kontakt','vita','impressum','datenschutz'];
  
  const sections={
    profil:{id:'content1',preserve:['.cv-header','blockquote','.cta-link']},
    leistungen:{id:'content3',preserve:[]},
    projekte:{id:'content4',preserve:[]},
    kontakt:{id:'content5',preserve:['.contact-form-section']},
    vita:{id:'vita-content',preserve:['h2']}
  };

  // Generate toolbar HTML
  function toolbarHtml(id){
    return `<div class="editor-toolbar">
      <button data-cmd="strong" title="Fett"><b>B</b></button>
      <button data-cmd="em" title="Kursiv"><i>I</i></button>
      <button data-cmd="u" title="Unterstrichen"><u>U</u></button>
      <span class="sep"></span>
      <button data-cmd="h3" title="√úberschrift">H3</button>
      <button data-cmd="p" title="Absatz">¬∂</button>
      <span class="sep"></span>
      <button data-cmd="ul" title="Liste">‚Ä¢ Liste</button>
      <button data-cmd="blockquote" title="Zitat">‚ùù</button>
      <span class="sep"></span>
      <button data-cmd="upper" title="GROSS">ABC</button>
      <button data-cmd="lower" title="klein">abc</button>
      <span class="sep"></span>
      <button data-cmd="link" title="Link">üîó</button>
      <button data-cmd="br" title="Umbruch">‚Üµ</button>
    </div>`;
  }

  // Generate editor panel HTML
  function createEditorPanels(){
    editorIds.forEach(id=>{
      const panel=$(id+'-panel');
      if(panel && panel.dataset.editor){
        panel.innerHTML=`<div class="editor-container">
          <div class="code-pane">${toolbarHtml(id)}<div class="cm-wrapper"><textarea id="editor-${id}"></textarea></div></div>
          <div class="preview-pane"><div class="preview-content" id="preview-${id}"></div></div>
        </div>`;
      }
    });
  }

  function init(){
    if(!localStorage.getItem('admin_pw')){$('login-form').style.display='none';$('setup-box').style.display='block';}
    if(sessionStorage.getItem('admin_auth'))showAdmin();
    bindEvents();
  }

  function bindEvents(){
    $('set-pw-btn').onclick=()=>{
      const pw=$('new-password').value,c=$('confirm-password').value;
      if(pw.length<4)return $('setup-error').textContent='Mind. 4 Zeichen';
      if(pw!==c)return $('setup-error').textContent='Passw√∂rter stimmen nicht √ºberein';
      localStorage.setItem('admin_pw',hash(pw));location.reload();
    };
    $('login-form').onsubmit=e=>{
      e.preventDefault();
      if(hash($('password').value)===localStorage.getItem('admin_pw')){
        sessionStorage.setItem('admin_auth','1');showAdmin();
      }else $('login-error').textContent='Falsches Passwort';
    };
    $('logout-btn').onclick=()=>{sessionStorage.removeItem('admin_auth');location.reload();};
    
    // Navigation
    $$('.nav-item').forEach(n=>n.onclick=e=>{
      e.preventDefault();
      $$('.nav-item').forEach(i=>i.classList.remove('active'));
      $$('.panel').forEach(p=>p.classList.remove('active'));
      n.classList.add('active');
      const panel=n.dataset.panel;
      $(panel+'-panel').classList.add('active');
      $('panel-title').innerHTML=n.textContent+'<span class="unsaved'+(hasChanges?' active':'')+'" id="unsaved"></span>';
      currentPanel=panel;
      if(editors[panel])setTimeout(()=>editors[panel].refresh(),10);
      if(panel==='styles'&&cssEditor)setTimeout(()=>{cssEditor.refresh();updateCssPreview();},10);
    });
    
    // View toggle
    $$('.view-toggle button').forEach(btn=>btn.onclick=()=>{
      $$('.view-toggle button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentView=btn.dataset.view;
      updateView();
    });
    
    // Toolbar clicks (event delegation)
    document.addEventListener('click',e=>{
      const btn=e.target.closest('.editor-toolbar button[data-cmd]');
      if(!btn)return;
      const cmd=btn.dataset.cmd;
      const toolbar=btn.closest('.editor-toolbar');
      const panel=toolbar.closest('.panel');
      const editorId=panel?.dataset.editor;
      if(!editorId||!editors[editorId])return;
      execCmd(editorId,cmd);
    });
    
    $('save-btn').onclick=saveAll;
    $('test-github').onclick=testGitHub;
    $('change-pw').onclick=changePw;
    ['seo-title','seo-description','seo-keywords','seo-og-title','seo-og-description'].forEach(id=>{
      $(id)?.addEventListener('input',markChanged);
    });
  }

  function showAdmin(){
    $('login-screen').style.display='none';
    $('admin-layout').classList.add('active');
    createEditorPanels();
    loadSettings();
    initEditors();
    initStylesPanel();
    loadContent();
  }

  function initEditors(){
    editorIds.forEach(id=>{
      const ta=$('editor-'+id);
      if(ta){
        editors[id]=CodeMirror.fromTextArea(ta,{
          mode:'htmlmixed',theme:'dracula',lineNumbers:true,lineWrapping:true,
          autoCloseTags:true,indentUnit:2,tabSize:2
        });
        editors[id].on('change',()=>{markChanged();updatePreview(id);});
      }
    });
    
    // CSS Editor
    const cssTa=$('editor-styles');
    if(cssTa){
      cssEditor=CodeMirror.fromTextArea(cssTa,{
        mode:'css',theme:'dracula',lineNumbers:true,lineWrapping:true,
        indentUnit:2,tabSize:2
      });
      cssEditor.on('change',()=>{
        markChanged();
        updateCssPreview();
        // Update color pickers when CSS changes
        setTimeout(extractCssVars, 300);
      });
    }
  }
  
  function updateCssPreview(){
    const iframe=$('styles-preview');
    if(!iframe||!cssEditor)return;
    try{
      const doc=iframe.contentDocument||iframe.contentWindow.document;
      if(!doc||!doc.head)return;
      // Deaktiviere das originale Stylesheet
      const origStyle=doc.querySelector('link[href*="style.css"]');
      if(origStyle)origStyle.disabled=true;
      // F√ºge/aktualisiere Live-CSS
      let liveStyle=doc.getElementById('admin-live-css');
      if(!liveStyle){
        liveStyle=doc.createElement('style');
        liveStyle.id='admin-live-css';
        doc.head.appendChild(liveStyle);
      }
      liveStyle.textContent=cssEditor.getValue();
    }catch(e){}
  }
  
  // Warte bis iframe geladen ist
  function setupPreviewIframe(){
    const iframe=$('styles-preview');
    if(iframe){
      iframe.onload=()=>setTimeout(updateCssPreview,100);
    }
  }
  
  // CSS Variablen aus dem Code extrahieren
  function extractCssVars(){
    if(!cssEditor)return;
    const css=cssEditor.getValue();
    const vars={
      'bg':/--bg:\s*([^;]+)/,
      'body':/--body:\s*([^;]+)/,
      'secondary':/--secondary:\s*([^;]+)/,
      'accent':/--accent:\s*([^;]+)/,
      'hover-bg':/--hover-bg:\s*([^;]+)/,
      'hover-text':/--hover-text:\s*([^;]+)/
    };
    Object.keys(vars).forEach(v=>{
      const match=css.match(vars[v]);
      if(match){
        const el=$('var-'+v);
        if(el){
          let color=match[1].trim();
          // Convert named colors to hex
          if(color==='blue')color='#0000ff';
          if(color==='black')color='#000000';
          if(color==='white')color='#ffffff';
          if(color.match(/^#[0-9a-f]{3}$/i))color=color.replace(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i,'#$1$1$2$2$3$3');
          el.value=color;
        }
      }
    });
  }
  
  // CSS Variable im Code aktualisieren
  function updateCssVar(varName,value){
    if(!cssEditor)return;
    let css=cssEditor.getValue();
    const regex=new RegExp(`(--${varName}:\\s*)([^;]+)`);
    if(css.match(regex)){
      css=css.replace(regex,`$1${value}`);
      cssEditor.setValue(css);
      markChanged();
    }
  }
  
// Responsive Preview
  function initStylesPanel(){
    setupPreviewIframe();
    
    // Color pickers
    ['bg','body','secondary','accent','hover-bg','hover-text'].forEach(v=>{
      const el=$('var-'+v);
      if(el)el.addEventListener('input',e=>updateCssVar(v,e.target.value));
    });
    
    // Responsive buttons
    $$('.preview-size').forEach(btn=>{
      btn.onclick=()=>{
        $$('.preview-size').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const iframe=$('styles-preview');
        if(iframe)iframe.style.width=btn.dataset.width;
      };
    });
    
    // Dark mode toggle
    $('dark-mode-toggle').onclick=function(){
      this.classList.toggle('active');
      const iframe=$('styles-preview');
      if(!iframe)return;
      const doc=iframe.contentDocument||iframe.contentWindow.document;
      const darkCss=`:root{--primary:#fff;--bg:#111;--body:#e5e5e5;--secondary:#999;--accent:#4d9fff;--hover-bg:#fff;--hover-text:#111}body{background:#111;color:#e5e5e5}`;
      let darkStyle=doc.getElementById('dark-override');
      if(this.classList.contains('active')){
        if(!darkStyle){
          darkStyle=doc.createElement('style');
          darkStyle.id='dark-override';
          doc.head.appendChild(darkStyle);
        }
        darkStyle.textContent=darkCss;
        this.textContent='‚òÄÔ∏è';
      }else{
        if(darkStyle)darkStyle.textContent='';
        this.textContent='üåô';
      }
    };
  }

  function execCmd(editorId,cmd){
    const ed=editors[editorId];
    if(!ed)return;
    const sel=ed.getSelection();
    const cur=ed.getCursor();
    
    if(cmd==='upper'&&sel){ed.replaceSelection(sel.toUpperCase());}
    else if(cmd==='lower'&&sel){ed.replaceSelection(sel.toLowerCase());}
    else if(cmd==='link'){
      const url=prompt('URL:','https://');
      if(url)ed.replaceSelection(`<a href="${url}">${sel||'Link'}</a>`);
    }
    else if(cmd==='br'){ed.replaceRange('<br>\n',cur);}
    else if(cmd==='ul'){
      if(sel){
        const items=sel.split('\n').filter(l=>l.trim()).map(l=>`  <li>${l.trim()}</li>`).join('\n');
        ed.replaceSelection(`<ul>\n${items}\n</ul>`);
      }else ed.replaceSelection('<ul>\n  <li></li>\n</ul>');
    }
    else if(sel){ed.replaceSelection(`<${cmd}>${sel}</${cmd}>`);}
    else{ed.replaceRange(`<${cmd}></${cmd}>`,cur);ed.setCursor({line:cur.line,ch:cur.ch+cmd.length+2});}
    
    ed.focus();
    markChanged();
    updatePreview(editorId);
  }

  function updatePreview(id){
    const p=$('preview-'+id);
    if(p&&editors[id])p.innerHTML=editors[id].getValue();
  }

  function updateView(){
    $$('.code-pane').forEach(p=>p.classList.toggle('hidden',currentView==='preview'));
    $$('.preview-pane').forEach(p=>p.classList.toggle('hidden',currentView==='code'));
    if(editors[currentPanel])setTimeout(()=>editors[currentPanel].refresh(),10);
  }

  function loadSettings(){
    $('github-token').value=localStorage.getItem('gh_token')||'';
    $('github-repo').value=localStorage.getItem('gh_repo')||'bschels/bschels.github.io';
    $('github-branch').value=localStorage.getItem('gh_branch')||'main';
  }

  async function loadContent(){
    showStatus('Lade...');
    try{
      const res=await fetch('/index.html?t='+Date.now());
      if(!res.ok)throw new Error('index.html nicht gefunden');
      indexHtml=await res.text();
      const doc=new DOMParser().parseFromString(indexHtml,'text/html');

      // Extract sections
      Object.keys(sections).forEach(key=>{
        const sec=sections[key];
        const el=doc.getElementById(sec.id);
        if(el&&editors[key]){
          const temp=document.createElement('div');
          temp.innerHTML=el.innerHTML;
          sec.preserve.forEach(s=>temp.querySelectorAll(s).forEach(e=>e.remove()));
          temp.querySelectorAll('hr.z').forEach(hr=>hr.remove());
          const content=temp.innerHTML.trim();
          editors[key].setValue(content);
          originalContent[key]=content; // Save for diff
          updatePreview(key);
        }
      });

      // Load subpages
      try{
        const imp=await fetch('/pages/impressum.html?t='+Date.now());
        if(imp.ok&&editors.impressum){editors.impressum.setValue(await imp.text());updatePreview('impressum');}
      }catch(e){}
      try{
        const ds=await fetch('/pages/datenschutz.html?t='+Date.now());
        if(ds.ok&&editors.datenschutz){editors.datenschutz.setValue(await ds.text());updatePreview('datenschutz');}
      }catch(e){}

      // SEO
      $('seo-title').value=doc.querySelector('title')?.textContent||'';
      $('seo-description').value=doc.querySelector('meta[name="description"]')?.content||'';
      $('seo-keywords').value=doc.querySelector('meta[name="keywords"]')?.content||'';
      $('seo-og-title').value=doc.querySelector('meta[property="og:title"]')?.content||'';
      $('seo-og-description').value=doc.querySelector('meta[property="og:description"]')?.content||'';
      charCount($('seo-title'),60);
      charCount($('seo-description'),160);
      
      // Load CSS
      try{
        const cssRes=await fetch('/style.css?t='+Date.now());
        if(cssRes.ok&&cssEditor){
          const cssText = await cssRes.text();
          cssEditor.setValue(cssText);
          originalContent['style.css']=cssText; // Save for diff
          extractCssVars();
          updateCssPreview();
        }
      }catch(e){}

      hasChanges=false;
      showStatus('Geladen ‚úì','success');
      setTimeout(hideStatus,1500);
    }catch(e){
      console.error(e);
      showStatus('Fehler: '+e.message,'error');
    }
  }

  function markChanged(){
    hasChanges=true;
    $('unsaved')?.classList.add('active');
  }

  async function saveAll(){
    const btn=$('save-btn');
    btn.disabled=true;btn.textContent='Speichert...';
    showStatus('Speichert...');

    const token=localStorage.getItem('gh_token')||$('github-token').value;
    if(!token){showStatus('Token fehlt!','error');btn.disabled=false;btn.textContent='üíæ Speichern';return;}

    localStorage.setItem('gh_token',$('github-token').value);
    localStorage.setItem('gh_repo',$('github-repo').value);
    localStorage.setItem('gh_branch',$('github-branch').value);

    try{
      await saveIndexHtml();
      if(editors.impressum)await saveFile('pages/impressum.html',editors.impressum.getValue());
      if(editors.datenschutz)await saveFile('pages/datenschutz.html',editors.datenschutz.getValue());
      if(cssEditor)await saveFile('style.css',cssEditor.getValue());

      hasChanges=false;
      $('unsaved')?.classList.remove('active');
      showStatus('Gespeichert ‚úì','success');
      setTimeout(hideStatus,2500);
    }catch(e){
      console.error(e);
      showStatus('Fehler: '+e.message,'error');
    }
    btn.disabled=false;btn.textContent='üíæ Speichern';
  }

  async function saveIndexHtml(){
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';

    const ghRes=await fetch(`https://api.github.com/repos/${repo}/contents/index.html?ref=${branch}`,{
      headers:{Authorization:`token ${token}`}
    });
    if(!ghRes.ok)throw new Error('index.html nicht gefunden');
    const ghData=await ghRes.json();
    let html=decodeURIComponent(escape(atob(ghData.content)));

    // Update SEO
    const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const escA=s=>s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    [
      {r:/<title>[^<]*<\/title>/,v:`<title>${esc($('seo-title').value)}</title>`},
      {r:/<meta name="description" content="[^"]*"/,v:`<meta name="description" content="${escA($('seo-description').value)}"`},
      {r:/<meta name="keywords" content="[^"]*"/,v:`<meta name="keywords" content="${escA($('seo-keywords').value)}"`},
      {r:/<meta property="og:title" content="[^"]*"/,v:`<meta property="og:title" content="${escA($('seo-og-title').value)}"`},
      {r:/<meta property="og:description" content="[^"]*"/,v:`<meta property="og:description" content="${escA($('seo-og-description').value)}"`}
    ].forEach(u=>html=html.replace(u.r,u.v));

    // Update sections
    Object.keys(sections).forEach(key=>{
      if(!editors[key])return;
      const sec=sections[key];
      const regex=new RegExp(`(<div[^>]*id="${sec.id}"[^>]*>)([\\s\\S]*?)(<hr class="z">\\s*</div>)`,'i');
      const match=html.match(regex);
      if(match){
        const tempDoc=new DOMParser().parseFromString(html,'text/html');
        const orig=tempDoc.getElementById(sec.id);
        let pre='',post='';
        if(orig){
          sec.preserve.forEach(s=>{
            const el=orig.querySelector(s);
            if(el){
              if(s==='.cv-header')pre=el.outerHTML+pre;
              else post+=el.outerHTML;
            }
          });
        }
        html=html.replace(regex,`$1${pre}${editors[key].getValue()}${post}<hr class="z"></div>`);
      }
    });

    await saveFile('index.html',html,ghData.sha);
  }

  async function saveFile(path,content,sha){
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';

    if(!sha){
      try{
        const r=await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`,{
          headers:{Authorization:`token ${token}`}
        });
        if(r.ok)sha=(await r.json()).sha;
      }catch(e){}
    }

    const body={message:`Admin: ${path}`,content:btoa(unescape(encodeURIComponent(content))),branch};
    if(sha)body.sha=sha;

    const res=await fetch(`https://api.github.com/repos/${repo}/contents/${path}`,{
      method:'PUT',
      headers:{Authorization:`token ${token}`,'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    if(!res.ok){
      const err=await res.json();
      throw new Error(err.message||'GitHub Fehler');
    }
  }

  async function testGitHub(){
    const token=$('github-token').value,repo=$('github-repo').value;
    try{
      const r=await fetch(`https://api.github.com/repos/${repo}`,{headers:{Authorization:`token ${token}`}});
      if(r.ok){
        $('github-status').innerHTML='<span class="success">‚úì</span>';
        localStorage.setItem('gh_token',token);
        localStorage.setItem('gh_repo',repo);
        localStorage.setItem('gh_branch',$('github-branch').value);
      }else $('github-status').innerHTML='<span class="error">Fehler</span>';
    }catch(e){$('github-status').innerHTML='<span class="error">Fehler</span>';}
  }

  function changePw(){
    const curr=$('pw-current').value,newPw=$('pw-new').value;
    if(hash(curr)!==localStorage.getItem('admin_pw'))return $('pw-status').innerHTML='<span class="error">Falsch</span>';
    if(newPw.length<4)return $('pw-status').innerHTML='<span class="error">Mind. 4</span>';
    localStorage.setItem('admin_pw',hash(newPw));
    $('pw-status').innerHTML='<span class="success">‚úì</span>';
    $('pw-current').value='';$('pw-new').value='';
  }

  function showStatus(msg,type=''){
    const el=$('status-bar');
    el.textContent=msg;
    el.className='status-bar active'+(type?' '+type:'');
  }
  function hideStatus(){$('status-bar').classList.remove('active');}

  window.charCount=function(el,max){
    const len=el.value.length;
    const c=$(el.id+'-count');
    if(c){
      c.textContent=len+'/'+max;
      c.className='char-count'+(len>max?' error':len>max*.9?' warning':'');
    }
  };

  // ========== FEATURE 1: Keyboard Shortcuts ==========
  document.addEventListener('keydown',e=>{
    if((e.metaKey||e.ctrlKey)&&e.key==='s'){
      e.preventDefault();
      if(hasChanges)saveAll();
    }
  });

  // ========== FEATURE 2: Warnung bei ungespeicherten √Ñnderungen ==========
  window.addEventListener('beforeunload',e=>{
    if(hasChanges){
      e.preventDefault();
      e.returnValue='';
    }
  });

  // ========== FEATURE 3: Sitemap aktualisieren ==========
  async function updateSitemap(){
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';
    const today=new Date().toISOString().split('T')[0];
    
    try{
      const r=await fetch(`https://api.github.com/repos/${repo}/contents/sitemap.xml?ref=${branch}`,{
        headers:{Authorization:`token ${token}`}
      });
      if(!r.ok)return;
      const data=await r.json();
      let xml=atob(data.content);
      xml=xml.replace(/<lastmod>\d{4}-\d{2}-\d{2}<\/lastmod>/g,`<lastmod>${today}</lastmod>`);
      await saveFile('sitemap.xml',xml,data.sha);
    }catch(e){console.log('Sitemap update failed:',e);}
  }

  // ========== FEATURE 5: Backup vor Speichern ==========
  let originalContent={};
  
  async function createBackup(){
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';
    
    try{
      const files=['index.html','style.css'];
      for(const file of files){
        const r=await fetch(`https://api.github.com/repos/${repo}/contents/${file}?ref=${branch}`,{
          headers:{Authorization:`token ${token}`}
        });
        if(r.ok){
          const data=await r.json();
          originalContent[file]=atob(data.content);
        }
      }
    }catch(e){}
  }

  // ========== FEATURE 6: Bilder-Verwaltung ==========
  async function loadImages(){
    const container=$('images-list');
    if(!container)return;
    container.innerHTML='<p style="color:#666">Lade Bilder...</p>';
    
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';
    
    try{
      const r=await fetch(`https://api.github.com/repos/${repo}/contents/images?ref=${branch}`,{
        headers:{Authorization:`token ${token}`}
      });
      if(!r.ok)throw new Error('Fehler');
      const files=await r.json();
      const images=files.filter(f=>f.name.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i));
      
      container.innerHTML=images.map(img=>`
        <div class="image-card" style="position:relative" onclick="copyPath('/images/${img.name}')">
          <img src="https://raw.githubusercontent.com/${repo}/${branch}/images/${img.name}" alt="${img.name}" onerror="this.style.display='none'">
          <div class="name">${img.name}</div>
          <button class="delete-img" onclick="event.stopPropagation();deleteImage('${img.name}','${img.sha}')" title="L√∂schen">√ó</button>
        </div>
      `).join('')||'<p style="color:#666">Keine Bilder gefunden</p>';
    }catch(e){
      container.innerHTML='<p style="color:#c00">Fehler beim Laden</p>';
    }
  }
  
  window.copyPath=function(path){
    navigator.clipboard.writeText(path);
    showStatus('Pfad kopiert: '+path,'success');
    setTimeout(hideStatus,1500);
  };
  
  window.deleteImage=async function(name,sha){
    if(!confirm(`"${name}" wirklich l√∂schen?`))return;
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';
    
    try{
      await fetch(`https://api.github.com/repos/${repo}/contents/images/${name}`,{
        method:'DELETE',
        headers:{Authorization:`token ${token}`,'Content-Type':'application/json'},
        body:JSON.stringify({message:`Delete ${name}`,sha,branch})
      });
      showStatus('Gel√∂scht ‚úì','success');
      loadImages();
    }catch(e){showStatus('Fehler','error');}
  };
  
  async function uploadImage(){
    const input=$('image-upload');
    const status=$('upload-status');
    if(!input.files[0]){status.textContent='Keine Datei';return;}
    
    const file=input.files[0];
    const token=localStorage.getItem('gh_token');
    const repo=localStorage.getItem('gh_repo');
    const branch=localStorage.getItem('gh_branch')||'main';
    
    status.textContent='L√§dt hoch...';
    
    const reader=new FileReader();
    reader.onload=async function(){
      const base64=reader.result.split(',')[1];
      try{
        await fetch(`https://api.github.com/repos/${repo}/contents/images/${file.name}`,{
          method:'PUT',
          headers:{Authorization:`token ${token}`,'Content-Type':'application/json'},
          body:JSON.stringify({message:`Upload ${file.name}`,content:base64,branch})
        });
        status.innerHTML='<span class="success">‚úì Hochgeladen</span>';
        input.value='';
        loadImages();
      }catch(e){status.innerHTML='<span class="error">Fehler</span>';}
    };
    reader.readAsDataURL(file);
  }

  // ========== FEATURE 7: GoatCounter Statistiken ==========
  async function loadStats(){
    const container=$('stats-container');
    if(!container)return;
    
    const token=$('goat-token')?.value||localStorage.getItem('goat_token');
    if(!token){
      container.innerHTML='<p style="color:#666">Bitte GoatCounter API Token eingeben</p>';
      return;
    }
    
    localStorage.setItem('goat_token',token);
    container.innerHTML='<p style="color:#666">Lade Statistiken...</p>';
    
    try{
      // Hole Statistiken f√ºr heute, diese Woche, diesen Monat
      const today=new Date().toISOString().split('T')[0];
      const weekAgo=new Date(Date.now()-7*24*60*60*1000).toISOString().split('T')[0];
      const monthAgo=new Date(Date.now()-30*24*60*60*1000).toISOString().split('T')[0];
      
      const headers={'Authorization':`Bearer ${token}`};
      
      // Total Stats
      const [totalRes,pagesRes]=await Promise.all([
        fetch(`https://schels.goatcounter.com/api/v0/stats/total?start=${monthAgo}&end=${today}`,{headers}),
        fetch(`https://schels.goatcounter.com/api/v0/stats/hits?start=${weekAgo}&end=${today}&limit=10`,{headers})
      ]);
      
      if(!totalRes.ok)throw new Error('API Fehler - Token pr√ºfen');
      
      const total=await totalRes.json();
      const pages=pagesRes.ok?await pagesRes.json():null;
      
      let html=`
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem">
          <div class="stat-card">
            <h4>Letzte 30 Tage</h4>
            <div class="value">${total.total?.toLocaleString('de-DE')||'‚Äì'}</div>
            <div style="font-size:.7rem;color:#666">Seitenaufrufe</div>
          </div>
          <div class="stat-card">
            <h4>Unique Visitors</h4>
            <div class="value">${total.total_unique?.toLocaleString('de-DE')||'‚Äì'}</div>
            <div style="font-size:.7rem;color:#666">Besucher</div>
          </div>
        </div>
      `;
      
      // Top Seiten
      if(pages&&pages.stats&&pages.stats.length){
        html+=`<div class="section-title" style="margin-top:1rem">Top Seiten (7 Tage)</div>`;
        pages.stats.slice(0,8).forEach(p=>{
          html+=`<div class="stat-row"><span>${p.name||p.path||'/'}</span><span><strong>${p.count}</strong></span></div>`;
        });
      }
      
      container.innerHTML=html;
      
    }catch(e){
      container.innerHTML=`
        <div class="info-box" style="background:#fff3cd;border-color:#ffc107">
          <strong>Fehler:</strong> ${e.message}<br>
          <small>Stelle sicher, dass der Token "read" Berechtigung hat.</small>
        </div>
      `;
    }
  }

  // ========== FEATURE 8: Diff-Ansicht ==========
  let pendingSave=null;
  
  window.showDiff=function(){
    const modal=$('diff-modal');
    const content=$('diff-content');
    if(!modal||!content)return;
    
    let diffHtml='';
    
    // Compare index.html sections
    Object.keys(sections).forEach(key=>{
      if(!editors[key])return;
      const current=editors[key].getValue();
      const original=originalContent[key]||'';
      if(current!==original){
        diffHtml+=`<div class="diff-file">üìÑ ${key}</div>`;
        diffHtml+=`<div class="diff-remove">${escapeHtmlDiff(original.substring(0,500))}${original.length>500?'...':''}</div>`;
        diffHtml+=`<div class="diff-add">${escapeHtmlDiff(current.substring(0,500))}${current.length>500?'...':''}</div>`;
      }
    });
    
    // CSS changes
    if(cssEditor&&originalContent['style.css']){
      const current=cssEditor.getValue();
      const original=originalContent['style.css'];
      if(current!==original){
        diffHtml+=`<div class="diff-file">üìÑ style.css</div>`;
        diffHtml+=`<div style="color:#666;font-size:11px">CSS wurde ge√§ndert (${current.length} Zeichen)</div>`;
      }
    }
    
    if(!diffHtml)diffHtml='<p style="color:#666">Keine √Ñnderungen erkannt</p>';
    
    content.innerHTML=diffHtml;
    modal.style.display='block';
  }
  
  function escapeHtmlDiff(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }
  
  window.closeDiff=function(){
    $('diff-modal').style.display='none';
  };

  // ========== Event Bindings f√ºr neue Features ==========
  function bindNewFeatures(){
    // Bilder
    $('upload-image-btn')?.addEventListener('click',uploadImage);
    $('refresh-stats')?.addEventListener('click',loadStats);
    
    // Diff Modal
    $('close-diff')?.addEventListener('click',closeDiff);
    $('diff-cancel')?.addEventListener('click',closeDiff);
    $('diff-save')?.addEventListener('click',()=>{closeDiff();saveAll();});
    
    // Navigation zu neuen Panels
    $$('.nav-item').forEach(n=>{
      const oldClick=n.onclick;
      n.onclick=e=>{
        if(oldClick)oldClick.call(n,e);
        const panel=n.dataset.panel;
        if(panel==='images')loadImages();
        if(panel==='stats'){
          // Load saved token
          const savedToken=localStorage.getItem('goat_token');
          if(savedToken&&$('goat-token'))$('goat-token').value=savedToken;
          loadStats();
        }
      };
    });
  }

  // Erweitere saveAll mit Backup und Sitemap
  const originalSaveAll=saveAll;
  saveAll=async function(){
    await createBackup();
    await originalSaveAll();
    await updateSitemap();
  };

  // Keyboard shortcut hint
  setTimeout(()=>{
    const saveBtn=$('save-btn');
    if(saveBtn){
      const hint=document.createElement('div');
      hint.className='keyboard-hint';
      hint.textContent='‚åòS / Ctrl+S';
      saveBtn.parentNode.appendChild(hint);
    }
  },100);

  init();
  setTimeout(bindNewFeatures,200);
})();
  </script>
</body>
</html>
